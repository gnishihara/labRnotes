<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>R の基礎</title>
    <meta charset="utf-8" />
    <meta name="author" content="GN Nishihara" />
    <script src="introduction_files/header-attrs/header-attrs.js"></script>
    <link href="introduction_files/tile-view/tile-view.css" rel="stylesheet" />
    <script src="introduction_files/tile-view/tile-view.js"></script>
    <link href="introduction_files/animate.css/animate.xaringan.css" rel="stylesheet" />
    <link href="introduction_files/tachyons/tachyons.min.css" rel="stylesheet" />
    <link href="introduction_files/panelset/panelset.css" rel="stylesheet" />
    <script src="introduction_files/panelset/panelset.js"></script>
    <link href="introduction_files/xaringanExtra-extra-styles/xaringanExtra-extra-styles.css" rel="stylesheet" />
    <link rel="stylesheet" href="xaringan-themer.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# R の基礎
## R の基本操作の紹介とデータの入出力
### GN Nishihara

---








## 目次

* [<svg aria-hidden="true" role="img" viewBox="0 0 581 512" style="height:1em;width:1.13em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:currentColor;overflow:visible;position:relative;"><path d="M581 226.6C581 119.1 450.9 32 290.5 32S0 119.1 0 226.6C0 322.4 103.3 402 239.4 418.1V480h99.1v-61.5c24.3-2.7 47.6-7.4 69.4-13.9L448 480h112l-67.4-113.7c54.5-35.4 88.4-84.9 88.4-139.7zm-466.8 14.5c0-73.5 98.9-133 220.8-133s211.9 40.7 211.9 133c0 50.1-26.5 85-70.3 106.4-2.4-1.6-4.7-2.9-6.4-3.7-10.2-5.2-27.8-10.5-27.8-10.5s86.6-6.4 86.6-92.7-90.6-87.9-90.6-87.9h-199V361c-74.1-21.5-125.2-67.1-125.2-119.9zm225.1 38.3v-55.6c57.8 0 87.8-6.8 87.8 27.3 0 36.5-38.2 28.3-87.8 28.3zm-.9 72.5H365c10.8 0 18.9 11.7 24 19.2-16.1 1.9-33 2.8-50.6 2.9v-22.1z"/></svg> の紹介・代入演算子・データ構造](#introduction)
* [<svg aria-hidden="true" role="img" viewBox="0 0 581 512" style="height:1em;width:1.13em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:currentColor;overflow:visible;position:relative;"><path d="M581 226.6C581 119.1 450.9 32 290.5 32S0 119.1 0 226.6C0 322.4 103.3 402 239.4 418.1V480h99.1v-61.5c24.3-2.7 47.6-7.4 69.4-13.9L448 480h112l-67.4-113.7c54.5-35.4 88.4-84.9 88.4-139.7zm-466.8 14.5c0-73.5 98.9-133 220.8-133s211.9 40.7 211.9 133c0 50.1-26.5 85-70.3 106.4-2.4-1.6-4.7-2.9-6.4-3.7-10.2-5.2-27.8-10.5-27.8-10.5s86.6-6.4 86.6-92.7-90.6-87.9-90.6-87.9h-199V361c-74.1-21.5-125.2-67.1-125.2-119.9zm225.1 38.3v-55.6c57.8 0 87.8-6.8 87.8 27.3 0 36.5-38.2 28.3-87.8 28.3zm-.9 72.5H365c10.8 0 18.9 11.7 24 19.2-16.1 1.9-33 2.8-50.6 2.9v-22.1z"/></svg> 関数の基本](#functions)
* [データの入出力](#data-io)
* [モダン <svg aria-hidden="true" role="img" viewBox="0 0 581 512" style="height:1em;width:1.13em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:currentColor;overflow:visible;position:relative;"><path d="M581 226.6C581 119.1 450.9 32 290.5 32S0 119.1 0 226.6C0 322.4 103.3 402 239.4 418.1V480h99.1v-61.5c24.3-2.7 47.6-7.4 69.4-13.9L448 480h112l-67.4-113.7c54.5-35.4 88.4-84.9 88.4-139.7zm-466.8 14.5c0-73.5 98.9-133 220.8-133s211.9 40.7 211.9 133c0 50.1-26.5 85-70.3 106.4-2.4-1.6-4.7-2.9-6.4-3.7-10.2-5.2-27.8-10.5-27.8-10.5s86.6-6.4 86.6-92.7-90.6-87.9-90.6-87.9h-199V361c-74.1-21.5-125.2-67.1-125.2-119.9zm225.1 38.3v-55.6c57.8 0 87.8-6.8 87.8 27.3 0 36.5-38.2 28.3-87.8 28.3zm-.9 72.5H365c10.8 0 18.9 11.7 24 19.2-16.1 1.9-33 2.8-50.6 2.9v-22.1z"/></svg> の紹介・データの入出力：`tidyverse`](#tidyverse)
* [データ加工・操作：`dplyr`](#tidyverse)
* [作図：`ggplot2`](#tidyverse)

---

## この資料・実習について

* <svg aria-hidden="true" role="img" viewBox="0 0 581 512" style="height:1em;width:1.13em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:currentColor;overflow:visible;position:relative;"><path d="M581 226.6C581 119.1 450.9 32 290.5 32S0 119.1 0 226.6C0 322.4 103.3 402 239.4 418.1V480h99.1v-61.5c24.3-2.7 47.6-7.4 69.4-13.9L448 480h112l-67.4-113.7c54.5-35.4 88.4-84.9 88.4-139.7zm-466.8 14.5c0-73.5 98.9-133 220.8-133s211.9 40.7 211.9 133c0 50.1-26.5 85-70.3 106.4-2.4-1.6-4.7-2.9-6.4-3.7-10.2-5.2-27.8-10.5-27.8-10.5s86.6-6.4 86.6-92.7-90.6-87.9-90.6-87.9h-199V361c-74.1-21.5-125.2-67.1-125.2-119.9zm225.1 38.3v-55.6c57.8 0 87.8-6.8 87.8 27.3 0 36.5-38.2 28.3-87.8 28.3zm-.9 72.5H365c10.8 0 18.9 11.7 24 19.2-16.1 1.9-33 2.8-50.6 2.9v-22.1z"/></svg> と RStudio はインストール済み
* <svg aria-hidden="true" role="img" viewBox="0 0 581 512" style="height:1em;width:1.13em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:currentColor;overflow:visible;position:relative;"><path d="M581 226.6C581 119.1 450.9 32 290.5 32S0 119.1 0 226.6C0 322.4 103.3 402 239.4 418.1V480h99.1v-61.5c24.3-2.7 47.6-7.4 69.4-13.9L448 480h112l-67.4-113.7c54.5-35.4 88.4-84.9 88.4-139.7zm-466.8 14.5c0-73.5 98.9-133 220.8-133s211.9 40.7 211.9 133c0 50.1-26.5 85-70.3 106.4-2.4-1.6-4.7-2.9-6.4-3.7-10.2-5.2-27.8-10.5-27.8-10.5s86.6-6.4 86.6-92.7-90.6-87.9-90.6-87.9h-199V361c-74.1-21.5-125.2-67.1-125.2-119.9zm225.1 38.3v-55.6c57.8 0 87.8-6.8 87.8 27.3 0 36.5-38.2 28.3-87.8 28.3zm-.9 72.5H365c10.8 0 18.9 11.7 24 19.2-16.1 1.9-33 2.8-50.6 2.9v-22.1z"/></svg>における単純計算方法はできる

* オレンジ色の文字はクリックできるリンクです。たとえば、下にある Fira Code についての文書はクリックできます。
* [Fira Code プログラミング用等幅フォントを使っています。](https://github.com/tonsky/FiraCode)
* このフォントにより、演算子は見やすくなります

**たとえば**

* `&lt;-` は `&lt;` と `-` の合字 (リガチャー, ligature) です `(ALT + -)`
* `|&gt;` は `|` と `&gt;` の合字です `(CTRL + SHIFT + M)`
* `&lt;=` は `&lt;` と `=` の合字です
* `!=` は `!` と `=` の合字です

**この資料は R version 4.1.1 (2021-08-10) 環境で作りました。使用したパッケージは `xaringan` と `xaringanthemer` です。**

---

class: middle, center, inverse
name: introduction

# <svg aria-hidden="true" role="img" viewBox="0 0 581 512" style="height:1em;width:1.13em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:currentColor;overflow:visible;position:relative;"><path d="M581 226.6C581 119.1 450.9 32 290.5 32S0 119.1 0 226.6C0 322.4 103.3 402 239.4 418.1V480h99.1v-61.5c24.3-2.7 47.6-7.4 69.4-13.9L448 480h112l-67.4-113.7c54.5-35.4 88.4-84.9 88.4-139.7zm-466.8 14.5c0-73.5 98.9-133 220.8-133s211.9 40.7 211.9 133c0 50.1-26.5 85-70.3 106.4-2.4-1.6-4.7-2.9-6.4-3.7-10.2-5.2-27.8-10.5-27.8-10.5s86.6-6.4 86.6-92.7-90.6-87.9-90.6-87.9h-199V361c-74.1-21.5-125.2-67.1-125.2-119.9zm225.1 38.3v-55.6c57.8 0 87.8-6.8 87.8 27.3 0 36.5-38.2 28.3-87.8 28.3zm-.9 72.5H365c10.8 0 18.9 11.7 24 19.2-16.1 1.9-33 2.8-50.6 2.9v-22.1z"/></svg> の紹介

---

## R 統計解析プログラミング言語

* <svg aria-hidden="true" role="img" viewBox="0 0 581 512" style="height:1em;width:1.13em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:currentColor;overflow:visible;position:relative;"><path d="M581 226.6C581 119.1 450.9 32 290.5 32S0 119.1 0 226.6C0 322.4 103.3 402 239.4 418.1V480h99.1v-61.5c24.3-2.7 47.6-7.4 69.4-13.9L448 480h112l-67.4-113.7c54.5-35.4 88.4-84.9 88.4-139.7zm-466.8 14.5c0-73.5 98.9-133 220.8-133s211.9 40.7 211.9 133c0 50.1-26.5 85-70.3 106.4-2.4-1.6-4.7-2.9-6.4-3.7-10.2-5.2-27.8-10.5-27.8-10.5s86.6-6.4 86.6-92.7-90.6-87.9-90.6-87.9h-199V361c-74.1-21.5-125.2-67.1-125.2-119.9zm225.1 38.3v-55.6c57.8 0 87.8-6.8 87.8 27.3 0 36.5-38.2 28.3-87.8 28.3zm-.9 72.5H365c10.8 0 18.9 11.7 24 19.2-16.1 1.9-33 2.8-50.6 2.9v-22.1z"/></svg> は統計解析に特化したプログラミング言語です。
* <svg aria-hidden="true" role="img" viewBox="0 0 581 512" style="height:1em;width:1.13em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:currentColor;overflow:visible;position:relative;"><path d="M581 226.6C581 119.1 450.9 32 290.5 32S0 119.1 0 226.6C0 322.4 103.3 402 239.4 418.1V480h99.1v-61.5c24.3-2.7 47.6-7.4 69.4-13.9L448 480h112l-67.4-113.7c54.5-35.4 88.4-84.9 88.4-139.7zm-466.8 14.5c0-73.5 98.9-133 220.8-133s211.9 40.7 211.9 133c0 50.1-26.5 85-70.3 106.4-2.4-1.6-4.7-2.9-6.4-3.7-10.2-5.2-27.8-10.5-27.8-10.5s86.6-6.4 86.6-92.7-90.6-87.9-90.6-87.9h-199V361c-74.1-21.5-125.2-67.1-125.2-119.9zm225.1 38.3v-55.6c57.8 0 87.8-6.8 87.8 27.3 0 36.5-38.2 28.3-87.8 28.3zm-.9 72.5H365c10.8 0 18.9 11.7 24 19.2-16.1 1.9-33 2.8-50.6 2.9v-22.1z"/></svg> のルーツは 1970年代に Bell Laboratories で開発された S 言語です。
* <svg aria-hidden="true" role="img" viewBox="0 0 581 512" style="height:1em;width:1.13em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:currentColor;overflow:visible;position:relative;"><path d="M581 226.6C581 119.1 450.9 32 290.5 32S0 119.1 0 226.6C0 322.4 103.3 402 239.4 418.1V480h99.1v-61.5c24.3-2.7 47.6-7.4 69.4-13.9L448 480h112l-67.4-113.7c54.5-35.4 88.4-84.9 88.4-139.7zm-466.8 14.5c0-73.5 98.9-133 220.8-133s211.9 40.7 211.9 133c0 50.1-26.5 85-70.3 106.4-2.4-1.6-4.7-2.9-6.4-3.7-10.2-5.2-27.8-10.5-27.8-10.5s86.6-6.4 86.6-92.7-90.6-87.9-90.6-87.9h-199V361c-74.1-21.5-125.2-67.1-125.2-119.9zm225.1 38.3v-55.6c57.8 0 87.8-6.8 87.8 27.3 0 36.5-38.2 28.3-87.8 28.3zm-.9 72.5H365c10.8 0 18.9 11.7 24 19.2-16.1 1.9-33 2.8-50.6 2.9v-22.1z"/></svg> は1991年に University of Auckland, New Zealand の Ross Ihaka と Robert Gentleman が開発しました。

* 私は 2004 年から <svg aria-hidden="true" role="img" viewBox="0 0 581 512" style="height:1em;width:1.13em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:currentColor;overflow:visible;position:relative;"><path d="M581 226.6C581 119.1 450.9 32 290.5 32S0 119.1 0 226.6C0 322.4 103.3 402 239.4 418.1V480h99.1v-61.5c24.3-2.7 47.6-7.4 69.4-13.9L448 480h112l-67.4-113.7c54.5-35.4 88.4-84.9 88.4-139.7zm-466.8 14.5c0-73.5 98.9-133 220.8-133s211.9 40.7 211.9 133c0 50.1-26.5 85-70.3 106.4-2.4-1.6-4.7-2.9-6.4-3.7-10.2-5.2-27.8-10.5-27.8-10.5s86.6-6.4 86.6-92.7-90.6-87.9-90.6-87.9h-199V361c-74.1-21.5-125.2-67.1-125.2-119.9zm225.1 38.3v-55.6c57.8 0 87.8-6.8 87.8 27.3 0 36.5-38.2 28.3-87.8 28.3zm-.9 72.5H365c10.8 0 18.9 11.7 24 19.2-16.1 1.9-33 2.8-50.6 2.9v-22.1z"/></svg> を使っています。


---

## 代入演算子 (assignment operator) とベクトル (vector) とは

.pull-left[

* 代入は `=` か `&lt;-` (`&lt;` と `-`) です。伝統的に使われる代入は `&lt;-` ですが、私は `=` を使っています。
* 左辺は変数名、右辺は値です。


```r
# 二種類の代入と c() 関数
a = 4.2
b &lt;- 5.0
c(a, b)
```

```
## [1] 4.2 5.0
```

* `c()` は渡された引数を結合します。
* `#` の後から続く文字列はコードとして実行されません。実行されない文書はコメントと呼びます。
]

.pull-right[


```r
(a + b) * c(a, b)
```

```
## [1] 38.64 46.00
```

* R はベクトル処理という実行機構が特徴的です。
* 上のコードは `\((a + b) \times a\)` と `\((a + b) \times b\)` を求めています。
]

RStudio の場合 `&lt;-` は `ALT + -` のショートカットを定義しています。

---

## R の主なデータタイプとデータ構造

.pull-left[

* 整数 integer
* 実数 double, numeric
* 複素数 complex number
* 時系列 time-series (POSIX)
* 文字列 character
* 論理値 logical
* 因子 factor
]

.pull-right[
* ベクトル　vector
* 配列 array, matrix
* リスト list
* テーブル（データフレーム） dataframe
]

---

## データの作り方

**ベクトル**

```r
a = c(10.3, 20.2, 30.1)
b = c("rabbit", "cat", "mouse", "dog")
d = c(TRUE, FALSE, T)
e = factor(c("nagasaki", "kagoshima", "fukuoka"))
```

**リスト**

ベクトルの長さは異なってもいい。
ここでは、リストの要素名を指定しました。


```r
z1 = list("A" = a, "B"= b, "D" = d, "E" = e)
```

**データフレーム**

ベクトルの長さを揃える必要がある。
ここでは`b[1:3]`を`b`に渡すことで、変数名を指定しました。


```r
z2 = data.frame(a, b = b[1:3], d, e)
```

---

## リストの構造を確認しよう

Rオブジェクトの構造 (structure) は `str()` で確認します。


```r
str(z1)
```

```
## List of 4
##  $ A: num [1:3] 10.3 20.2 30.1
##  $ B: chr [1:4] "rabbit" "cat" "mouse" "dog"
##  $ D: logi [1:3] TRUE FALSE TRUE
##  $ E: Factor w/ 3 levels "fukuoka","kagoshima",..: 3 2 1
```

---

## リストからデータを抽出する

リストの要素は次のように抽出できます。


```r
z1$A
```

```
## [1] 10.3 20.2 30.1
```

リストからの抽出方法は `$` 以外に, `[` や `[[` でもできます。


```r
z1[c("A", "D")]
z1[c(1,4)]
z1[[2]]
z1[[c(2,3)]]
z1[[2]][c(1,2)]
```

---

## データフレームの構造を確認しよう


```r
str(z2)
```

```
## 'data.frame':	3 obs. of  4 variables:
##  $ a: num  10.3 20.2 30.1
##  $ b: chr  "rabbit" "cat" "mouse"
##  $ d: logi  TRUE FALSE TRUE
##  $ e: Factor w/ 3 levels "fukuoka","kagoshima",..: 3 2 1
```

リストと似ていますが、そもそもデータフレームはリストです。
つまり、リストと同じように操作できます。

.pull-left[



```r
z2$a
```

```
## [1] 10.3 20.2 30.1
```
]

.pull-right[


```r
z2[c("a", "d")]
z2[c(1, 4)]
z2[[2]]
z2[[c(2,3)]]
z2[[2]][c(1,2)]
```
]

---

## 比較演算

.pull-left[

* 比較に使う論理演算子：`&amp;`（論理積 AND）, `|` （論理和 OR）, `!`（否定 NOT）


```r
A = c(5, 3, 2)
B = c(5, 2, 1)

# 論理積
(A[1] &gt; B[1]) &amp; (A[1] == B[1])
```

```
## [1] FALSE
```

```r
# 論理和
(A[1] &gt; B[1]) | (A[1] == B[1])
```

```
## [1] TRUE
```
]

.pull-right[


```r
# 否定と論理積
!(A[1] &gt; B[1]) &amp; (A[1] == B[1])
```

```
## [1] TRUE
```

```r
# 否定と論理和
(A[1] &lt; B[2]) | !(A[1] == B[1])
```

```
## [1] FALSE
```
]

---

## 比較演算を使ったデータの抽出

.pull-left[


```r
a = c(10.3, 20.2, 30.1)
b = c("rabbit", "cat", "mouse")
d = c(TRUE, FALSE, T)
e = factor(c("nagasaki", 
             "kagoshima", 
             "fukuoka"))
Z = data.frame(a, b, d, e)
Z[Z$a &gt; 20, ]
```

```
##      a     b     d         e
## 2 20.2   cat FALSE kagoshima
## 3 30.1 mouse  TRUE   fukuoka
```
]

.pull-right[

```r
Z[Z$a &gt; 10 &amp; Z$a &lt; 20.2, ]
```

```
##      a      b    d        e
## 1 10.3 rabbit TRUE nagasaki
```

```r
Z[Z$a &gt; 10 &amp; Z$a &lt;= 20.2, ]
```

```
##      a      b     d         e
## 1 10.3 rabbit  TRUE  nagasaki
## 2 20.2    cat FALSE kagoshima
```

```r
Z[identical(Z$a, 20) | !Z$d, ]
```

```
##      a   b     d         e
## 2 20.2 cat FALSE kagoshima
```

]

---

## **重要!** 数値を比較について

パソコンは 2 進数で計算しているので、数値は正確ではない！

**たとえば：**


```r
0.2 * 0.2 / 0.2 == 0.2 # = と =
```

```
## [1] FALSE
```

数値の比較をする場合は `all.equal()` を使いましょう。


```r
all.equal(0.2 * 0.2 / 0.2, 0.2, tolerance = 0) # 上のコードと同じ
```

```
## [1] "Mean relative difference: 1.387779e-16"
```

```r
all.equal(0.2 * 0.2 / 0.2, 0.2, tolerance = .Machine$double.eps) # 機械誤差を考慮した比較
```

```
## [1] TRUE
```

* ちなみに比較用記号は `&lt;`, `&gt;`, `&gt;=` (`&gt;` と `=`), `&lt;=` (`&lt;` と `=`), `!=` (`!` と `=`), `==` (`=` と `=`)　です。

---

class: middle, center, inverse
name: functions

# R 関数の基本

関数をつくることにより、<svg aria-hidden="true" role="img" viewBox="0 0 581 512" style="height:1em;width:1.13em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:currentColor;overflow:visible;position:relative;"><path d="M581 226.6C581 119.1 450.9 32 290.5 32S0 119.1 0 226.6C0 322.4 103.3 402 239.4 418.1V480h99.1v-61.5c24.3-2.7 47.6-7.4 69.4-13.9L448 480h112l-67.4-113.7c54.5-35.4 88.4-84.9 88.4-139.7zm-466.8 14.5c0-73.5 98.9-133 220.8-133s211.9 40.7 211.9 133c0 50.1-26.5 85-70.3 106.4-2.4-1.6-4.7-2.9-6.4-3.7-10.2-5.2-27.8-10.5-27.8-10.5s86.6-6.4 86.6-92.7-90.6-87.9-90.6-87.9h-199V361c-74.1-21.5-125.2-67.1-125.2-119.9zm225.1 38.3v-55.6c57.8 0 87.8-6.8 87.8 27.3 0 36.5-38.2 28.3-87.8 28.3zm-.9 72.5H365c10.8 0 18.9 11.7 24 19.2-16.1 1.9-33 2.8-50.6 2.9v-22.1z"/></svg> での作業がとても楽になります。
コードを繰り返して使うなら関数をつくりましょう。

---

## 関数の作り方

**R の関数に 2 つのパーツがあります。**

* **Arguments**: 引数
* **Code block**: 関数のコードは `{}` の間に納めます。


```r
hello = function(x) {
  if(!is.character(x)) {
    stop("Please provide a character string.")
  }
  sprintf("Hello %s!", x)
}

hello(214)
```

```
## Error in hello(214): Please provide a character string.
```

```r
hello("Yukio")
```

```
## [1] "Hello Yukio!"
```

---

## 関数のスコープ (scope)（１）

関数の中に作ったものは、関数の中にしか存在しない。




```r
sumofsquare = function(x) {
  ss = (x - mean(x))^2 # 関数の外から見れない
  ssq = sum(ss) # 関数の外から見れない
  ssq # 関数の外に返す
}
data = sample(1:10, 5, replace = TRUE)
data
```

```
## [1]  7  6 10  7  4
```

```r
value = sumofsquare(data)
value
```

```
## [1] 18.8
```

```r
ss
```

```
## Error in eval(expr, envir, enclos): object 'ss' not found
```

---

## 関数のスコープ (scope)（２）

ところが、関数は外の環境に存在するものは見れます。
このように関数を作ると、バグを起こしやすいので、注意。


```r
sumofsquare = function(x) {
  ss = (s - mean(s))^2 # s は関数の外にあるが、関数の引数ではない
  ssq = sum(ss) # 関数の外から見れない
  ssq # 関数の外に返す
}
s = sample(100:1000, 5, replace = TRUE)
s
```

```
## [1] 169 291 862 713 721
```

```r
data = sample(1:10, 5, replace = TRUE)
data
```

```
## [1] 5 7 9 7 3
```

```r
value = sumofsquare(data)
value　# これは s の平方和です。
```

```
## [1] 365388.8
```

---

## 諸略した関数の書き方と無名関数 (anonymous function)

関数は次のようにもかけます。
`\(x){...}` はラムダ式 (lambda expression) とも呼ばれています。


```r
add_one = \(x) { x + 1}
add_one(5)
```

```
## [1] 6
```

無名関数をつくるときに便利な書き方です。


```r
# どちれも無名関数ですが、２つ目の関数がはラムダ式です。
z = 1:5
sapply(z, FUN = function(s){s^2})
```

```
## [1]  1  4  9 16 25
```

```r
sapply(z, FUN = \(s){s^2})
```

```
## [1]  1  4  9 16 25
```

---
class: middle, center, inverse
name: tidyverse

# `tidyverse` 

.left[

&gt; Hadley Wickhamが開発した、タイディバースはRのプログラマーの中で最も使われているデータ分析パッケージです。
&gt; データの読み込み、抽出、加工、可視化を助けてくれる関数の解析システムです。
&gt; `tidyverse` の基礎となるアイディアは `tidy` な解析コードを開発することです。
つまり、だれでも読めるすぐに実行できるコードのことですね。
]

---

## `tidyverse`

`tidyverse` はメタパッケージなので、`library(tidyverse)` を実行すると次の 8 つのパッケージが読み込まれます。

* dplyr：データの変形・加工
* forcats：`factor()` 因子が使いやすくなります
* ggplot2：データの可視化・作図
* purrr ：関数型プログラミング
* readr ：CSV、TSVデータの読み込み
* stringr ：文字列の操作が楽になる
* tibble ：データフレームの操作が楽になる
* tidyr ：データをタイディ (tidy) にして操作しやすくなる

`tidyverse` の概念をもっと知りたい方は[tidyverse のマニフェスト](https://cran.r-project.org/web/packages/tidyverse/vignettes/manifesto.html)を読みましょう。

---

class: middle, center, inverse
name: data-io

# Data I/O

データ解析をするためには, データを <svg aria-hidden="true" role="img" viewBox="0 0 581 512" style="height:1em;width:1.13em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:currentColor;overflow:visible;position:relative;"><path d="M581 226.6C581 119.1 450.9 32 290.5 32S0 119.1 0 226.6C0 322.4 103.3 402 239.4 418.1V480h99.1v-61.5c24.3-2.7 47.6-7.4 69.4-13.9L448 480h112l-67.4-113.7c54.5-35.4 88.4-84.9 88.4-139.7zm-466.8 14.5c0-73.5 98.9-133 220.8-133s211.9 40.7 211.9 133c0 50.1-26.5 85-70.3 106.4-2.4-1.6-4.7-2.9-6.4-3.7-10.2-5.2-27.8-10.5-27.8-10.5s86.6-6.4 86.6-92.7-90.6-87.9-90.6-87.9h-199V361c-74.1-21.5-125.2-67.1-125.2-119.9zm225.1 38.3v-55.6c57.8 0 87.8-6.8 87.8 27.3 0 36.5-38.2 28.3-87.8 28.3zm-.9 72.5H365c10.8 0 18.9 11.7 24 19.2-16.1 1.9-33 2.8-50.6 2.9v-22.1z"/></svg> に読み込む必要があります。

ベースRの関数または外部パッケージの関数を使えば, 様々なデータファイルを簡単に読み込めます。

---

## `tibble` には list 列を入れられる

.pull-left[

ちょっと高度の方法ですが, list を変数の要素として記録できます。


```r
a1 = list(1,5,1,3,5,1)
a2 = list(2,3,5,2)
a3 = list("A","b","E")
tibble(a = 1:3, values = list(a1, a2, a3))
```

```
## # A tibble: 3 x 2
##       a values    
##   &lt;int&gt; &lt;list&gt;    
## 1     1 &lt;list [6]&gt;
## 2     2 &lt;list [4]&gt;
## 3     3 &lt;list [3]&gt;
```

`values` 列は list の list ですね。
]
.pull-right[


&lt;img src="introduction_files/figure-html/unnamed-chunk-27-1.png" width="70%" /&gt;

]

---

## 列名・変数名について

.pull-left[

`data.frame()` は無効な変数名を自動的に変更します。


```r
data.frame(`1 name` = 1) |&gt; names()
```

```
## [1] "X1.name"
```

`tibble()` はそのままにしてくれます。


```r
tibble(`1 name` = 1) |&gt; names()
```

```
## [1] "1 name"
```
]

.pull-right[


**`data.frame()`の場合**
* **有効な変数名：**文字または、ドット(.)と文字から始まる文字列。変数名に使用できるものは文字、数字、ドットとアンダースコア (_) だけです。
* **無効な変数名の例：**`2021FY`, `2021 FY`, `2020-FY`, `FY-2021` は自動的に `X2021FY`, `X2021.FY`, `X2020.FY`, `FY.2021` に変更されます。

**`tibble()`の場合**
* 変数名はそのまま使えますが、使うときは `` ` `` `` ` `` （バクチック）に囲んでください。
]

**ところが!**
どうしても `data.frame()` に無効な変数名を使いたいのであれば、`check.names = F` を渡してください。


```r
data.frame(`1 name` = 1, check.names = FALSE) |&gt; names()
```

```
## [1] "1 name"
```

---

## 引数を連続的に使える

`tibble()`はこのように, 計算処理をしながらデータフレームを構築できます。


```r
tibble(x = 1:4, `x^2` = x^2, `sqrt(x)` = sqrt(x))
```

```
## # A tibble: 4 x 3
##       x `x^2` `sqrt(x)`
##   &lt;int&gt; &lt;dbl&gt;     &lt;dbl&gt;
## 1     1     1      1   
## 2     2     4      1.41
## 3     3     9      1.73
## 4     4    16      2
```

---

## ベクトルをリサイクルしない

.pull-left[

二つのベクトルの長さが異なるときに, データフレームを作ると, 小さいほうのベクトルは先頭から繰り返して使われます。ただし長いベクトルの要素数は短いベクトルの要素数で除算できる必要があります。


```r
x = 1:4
y = 1:8
data.frame(x, y)
```

```
##   x y
## 1 1 1
## 2 2 2
## 3 3 3
## 4 4 4
## 5 1 5
## 6 2 6
## 7 3 7
## 8 4 8
```
]

.pull-right[

ところが, この機能はデータ解析時にバグの原因になります。`tibble()`はベクトルのリサイクルはできません。


```r
x = 1:4
y = 1:8
tibble(x, y)
```

```
## Error: Tibble columns must have compatible sizes.
## * Size 4: Existing data.
## * Size 8: Column at position 2.
## ℹ Only values of size one are recycled.
```
]

---

## I/O 関係の関数

**読み込み関数**

* `read_delim()`：一般性の高い関数, 区切りの指定が必要
* `read_csv()`：コンマ区切りフィアルの読み込み（csv ファイル）
* `read_table()`：ホワイトスペース区切りファイルの読み込み（タブ・スペース区切りファイル）
* `read_rds()`：R オブジェクトの読み込み

**書き出し関数**

* `write_delim()`：一般性の高い関数, 区切りの指定が必要
* `write_csv()`：コンマ区切りフィアルの書き出し
* `write_table()`：ホワイトスペース区切りファイルの書き出し（タブ・スペース区切りファイル）
* `write_rds()`：R オブジェクトの書き出し
* `ggsave()`: `ggplot2` でつくった図を書き出し

---

## `read_csv()` の重要な引数

* `file`：パスとファイル名
* `col_names = TRUE`：TRUEのとき, 1行目は列名として使う, FALSE のときは列名を自動的に作成する, 文字列ベクトルを渡せば読み込み中に列名を付けられます
* `col_types = NULL`：列のデータ型を指定できるが NULL のときは関数に任せる
* `comment = ""`：コメント記号を指定し, コメント記号後の文字を無視する
* `skip = 0`             先頭から無視する行数
* `locale`：ロケール（地域の設定）
* `n_max = Inf`：読み込む行数、デフォルトは全ての行数

---

## `read_csv()`の使い方

`read_csv()`

```r
rabbits = read_csv("Assignment_06_Dataset01.csv")
rabbits
```

```
## # A tibble: 37 x 2
##    host    scutum.width
##    &lt;chr&gt;          &lt;dbl&gt;
##  1 Rabbit1          380
##  2 Rabbit1          376
##  3 Rabbit1          360
##  4 Rabbit1          368
##  5 Rabbit1          372
##  6 Rabbit1          366
##  7 Rabbit1          374
##  8 Rabbit1          382
##  9 Rabbit2          350
## 10 Rabbit2          356
## # … with 27 more rows
```

---

## readxl パッケージ

`readxl` は Microsoft Excelファイルの読み込みに使えるパッケージです。


```r
library(readxl)
```

ファイルの読み込みには `read_excel()` を使いますが、研究室では `read_xlsx()` もよく使います。
`read_excel()` は `read_xlsx()` のラッパーです。
使い方は全くおなじです。

**重要：** エクセルでデータの管理をした場合エクセルのオートコレクト機能によってデータがかってに変換されるので気をつけましょう。遺伝子の名前のオートコレクトによく問題が発生すると報告されています。とくに Excel と Google Sheets のオートコレクトはアグレッシブです。[Abeysooriya et al. 2021. PLOS Computational Biology](https://doi.org/10.1371/journal.pcbi.1008984)。

---

## `read_excel()` の主な引数

* `path`：パスとファイル名
* `sheet = NULL`：読み込むシート名またはシートインデックス
* `range = NULL`：読み込む範囲, 例えば "B3:D8" または, "Data!B3:D8"
* `col_names = TRUE`：1行目を列名として使う論理値
* `col_types = NULL`：読み込む列のデータ型を指定できます (デフォルトは guess)
* `na = ""`：欠損値の定義, 空セルは欠損値とされます
* `skip = 0`：無視する行数
* `n_max = Inf`：読み込む最大行数

---

## `read_excel()` の使用例（１）

最初のシート (`sheet = 1`) の先頭から1行無視して (`skip = 1`) データを読み込む。


```r
filename = "Table 2.xlsx"
exceldata = read_excel(filename, sheet = 1, skip = 1)
exceldata
```


```
## # A tibble: 12 x 6
##    Month `WT (˚C)...2` `S.D.**...3` ...4  `WT (˚C)...5` `S.D.**...6`
##    &lt;chr&gt;         &lt;dbl&gt;        &lt;dbl&gt; &lt;lgl&gt;         &lt;dbl&gt;        &lt;dbl&gt;
##  1 Jan.           21.1        0.446 NA             16.5        0.428
##  2 Feb.           21.3        0.441 NA             16.3        0.483
##  3 Mar.           21.5        0.470 NA             16.5        0.579
##  4 Apr.           21.8        0.554 NA             18.3        1.27 
##  5 May            23.4        0.726 NA             21.1        1.08 
##  6 Jun.           25.5        1.20  NA             22.9        1.02 
##  7 Jul.           28.6        0.491 NA             26.6        1.15 
##  8 Aug.           28.8        0.546 NA             28.5        0.470
##  9 Sep.           28.5        0.375 NA             27.7        0.794
## 10 Oct.           26.6        0.893 NA             24.4        1.05 
## 11 Nov.           24.7        0.516 NA             21.6        0.928
## 12 Dec.           22.8        0.720 NA             19.1        0.893
```

---

## `read_excel()` の使用例（２）

先程のように読み込むと、不都合な変数名に変換されました。次は、変数名も指定して読み込みます。


```r
filename = "Table 2.xlsx"
col_names = c("month", "temperature1", "sd1", "empty","temperature2", "sd2")
exceldata = read_excel(filename, sheet = 1, skip = 2, col_name = col_names)
exceldata |&gt; print(n = 4)
```


```
## # A tibble: 12 x 6
##   month temperature1   sd1 empty temperature2   sd2
##   &lt;chr&gt;        &lt;dbl&gt; &lt;dbl&gt; &lt;lgl&gt;        &lt;dbl&gt; &lt;dbl&gt;
## 1 Jan.          21.1 0.446 NA            16.5 0.428
## 2 Feb.          21.3 0.441 NA            16.3 0.483
## 3 Mar.          21.5 0.470 NA            16.5 0.579
## 4 Apr.          21.8 0.554 NA            18.3 1.27 
## # … with 8 more rows
```

シートの２行目には変数名が記録されているので、`skip = 2` を渡しました。

---

## データの出力

**CSVファイルの出力**


```r
fname = "table2_output.csv"
exceldata |&gt; write_csv(file = fname) # 文字コードは UTF-8 です。
```

エクセルにCSVファイルを読み込んで文字化けした場合、`write_excel_csv()`を試してみてください。


```r
exceldata |&gt; write_excel_csv(file = fname)
```

**RDSファイルの出力**

Rのオブジェクトをバイナリファイルとして保存したい場合は `write_rds()` を使います。


```r
fname = "table2_output.rds"
exceldata |&gt; write_rds(file = fname)
```

---

class: middle, center, inverse
name: dplyr

# `dplyr` と `tidyr` によるデータ加工・操作

---

## 理想的なデータ構造


.large[
* 1 行 = 1 観測値
* 1 列 = 1 変数
]

---

## データ加工・操作用関数

**データの結合 (mutating join)**

`x`, `y`, `by` は関数の引数です。`by` で指定したキー（変数名）が一致するように行を合わせることができる。

* `full_join(x, y, by)`：全ての `x` と `y` 行と列を結合する。
* `inner_join(x, y, by)`：`x` と `y` で共通する行と列を結合する。
* `left_join(x, y, by)`：左側（）第 1 引数のtibble に `y` の変数を追加する。
* `right_join(x, y, by)`：右側（）第 2 引数のtibble に `x` の変数を追加する。


**データの結合 (join)**

* `bind_cols()`：渡したtibbleを横に結合する（行数が異なったらエラーが発生する）。
* `bind_rows()`：渡した tibble を立てに結合する（一致する変数名を合わせてくれます）。

---

## mutating join のつかいかた

.panelset[
.panel[.panel-name[tibble]

```r
X = tibble(x = c("A", "B", "C", "G"), y = c(NA, rnorm(3, mean = 5)))
Y = tibble(x = c("A", "C", "D", "E"), z = c(rpois(3, lambda = 5), NA))
```
.pull-left[

```r
X
```

```
## # A tibble: 4 x 2
##   x         y
##   &lt;chr&gt; &lt;dbl&gt;
## 1 A     NA   
## 2 B      3.92
## 3 C      4.73
## 4 G      5.18
```
]
.pull-right[

```r
Y
```

```
## # A tibble: 4 x 2
##   x         z
##   &lt;chr&gt; &lt;int&gt;
## 1 A         9
## 2 C         8
## 3 D         9
## 4 E        NA
```
]
]
.panel[.panel-name[full_join()]

```r
full_join(X,Y, by = "x")
```

```
## # A tibble: 6 x 3
##   x         y     z
##   &lt;chr&gt; &lt;dbl&gt; &lt;int&gt;
## 1 A     NA        9
## 2 B      3.92    NA
## 3 C      4.73     8
## 4 G      5.18    NA
## 5 D     NA        9
## 6 E     NA       NA
```
]
.panel[.panel-name[inner_join()]


```r
inner_join(X, Y, by = "x")
```

```
## # A tibble: 2 x 3
##   x         y     z
##   &lt;chr&gt; &lt;dbl&gt; &lt;int&gt;
## 1 A     NA        9
## 2 C      4.73     8
```
]
.panel[.panel-name[left_join()]


```r
left_join(X, Y, by = "x")
```

```
## # A tibble: 4 x 3
##   x         y     z
##   &lt;chr&gt; &lt;dbl&gt; &lt;int&gt;
## 1 A     NA        9
## 2 B      3.92    NA
## 3 C      4.73     8
## 4 G      5.18    NA
```
]
.panel[.panel-name[right_join()]


```r
right_join(X, Y, by = "x")
```

```
## # A tibble: 4 x 3
##   x         y     z
##   &lt;chr&gt; &lt;dbl&gt; &lt;int&gt;
## 1 A     NA        9
## 2 C      4.73     8
## 3 D     NA        9
## 4 E     NA       NA
```
]
.panel[.panel-name[bind_rows()]
.pull-left[

```r
bind_rows(X, Y)
```

```
## # A tibble: 8 x 3
##   x         y     z
##   &lt;chr&gt; &lt;dbl&gt; &lt;int&gt;
## 1 A     NA       NA
## 2 B      3.92    NA
## 3 C      4.73    NA
## 4 G      5.18    NA
## 5 A     NA        9
## 6 C     NA        8
## 7 D     NA        9
## 8 E     NA       NA
```

]
.pull-right[

```r
bind_rows("X" = X, "Y" = Y, .id = "origin")
```

```
## # A tibble: 8 x 4
##   origin x         y     z
##   &lt;chr&gt;  &lt;chr&gt; &lt;dbl&gt; &lt;int&gt;
## 1 X      A     NA       NA
## 2 X      B      3.92    NA
## 3 X      C      4.73    NA
## 4 X      G      5.18    NA
## 5 Y      A     NA        9
## 6 Y      C     NA        8
## 7 Y      D     NA        9
## 8 Y      E     NA       NA
```
]
]
.panel[.panel-name[bind_cols()]

```r
bind_cols(X, Y)
```

```
## # A tibble: 4 x 4
##   x...1     y x...3     z
##   &lt;chr&gt; &lt;dbl&gt; &lt;chr&gt; &lt;int&gt;
## 1 A     NA    A         9
## 2 B      3.92 C         8
## 3 C      4.73 D         9
## 4 G      5.18 E        NA
```
]
]

---

## 行と列の加工・操作用関数

.pull-left[
**列における操作**

* `mutate()`：既存の変数の書き換えや変数の追加する
* `select()`：既存の変数を選らぶ
* `rename()`：既存の変数の名前を変える
* `pull()`：既存の変数をリストとして抽出する
* `relocate()``：指定した列の位置を変える
]

.pull-right[
**行における操作**

* `filter()`：条件を満たした行を返す
* `distinct()`：指定した変数から重複している行を外す
* `slice()`：指定した行インデックスを返す
* `arrange()`：指定した列の昇順で行を並べ替える
]

---

## 列の加工

.panelset[
.panel[.panel-name[mutate()]

```r
iris |&gt; as_tibble() |&gt; mutate(P2 = Petal.Length^2)
```

```
## # A tibble: 150 x 6
##    Sepal.Length Sepal.Width Petal.Length Petal.Width Species    P2
##           &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;   &lt;dbl&gt;
##  1          5.1         3.5          1.4         0.2 setosa   1.96
##  2          4.9         3            1.4         0.2 setosa   1.96
##  3          4.7         3.2          1.3         0.2 setosa   1.69
##  4          4.6         3.1          1.5         0.2 setosa   2.25
##  5          5           3.6          1.4         0.2 setosa   1.96
##  6          5.4         3.9          1.7         0.4 setosa   2.89
##  7          4.6         3.4          1.4         0.3 setosa   1.96
##  8          5           3.4          1.5         0.2 setosa   2.25
##  9          4.4         2.9          1.4         0.2 setosa   1.96
## 10          4.9         3.1          1.5         0.1 setosa   2.25
## # … with 140 more rows
```
]
.panel[.panel-name[select()]
.pull-left[

```r
iris |&gt; as_tibble() |&gt; select(Species, Petal.Length)
```

```
## # A tibble: 150 x 2
##    Species Petal.Length
##    &lt;fct&gt;          &lt;dbl&gt;
##  1 setosa           1.4
##  2 setosa           1.4
##  3 setosa           1.3
##  4 setosa           1.5
##  5 setosa           1.4
##  6 setosa           1.7
##  7 setosa           1.4
##  8 setosa           1.5
##  9 setosa           1.4
## 10 setosa           1.5
## # … with 140 more rows
```
]
.pull-right[

```r
iris |&gt; as_tibble() |&gt; select(matches("Length"))
```

```
## # A tibble: 150 x 2
##    Sepal.Length Petal.Length
##           &lt;dbl&gt;        &lt;dbl&gt;
##  1          5.1          1.4
##  2          4.9          1.4
##  3          4.7          1.3
##  4          4.6          1.5
##  5          5            1.4
##  6          5.4          1.7
##  7          4.6          1.4
##  8          5            1.5
##  9          4.4          1.4
## 10          4.9          1.5
## # … with 140 more rows
```
]
]
.panel[.panel-name[rename()]
.pull-left[
.small[

```r
iris |&gt; as_tibble() |&gt; rename(PL = Petal.Length)
```

```
## # A tibble: 150 x 5
##    Sepal.Length Sepal.Width    PL Petal.Width Species
##           &lt;dbl&gt;       &lt;dbl&gt; &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;  
##  1          5.1         3.5   1.4         0.2 setosa 
##  2          4.9         3     1.4         0.2 setosa 
##  3          4.7         3.2   1.3         0.2 setosa 
##  4          4.6         3.1   1.5         0.2 setosa 
##  5          5           3.6   1.4         0.2 setosa 
##  6          5.4         3.9   1.7         0.4 setosa 
##  7          4.6         3.4   1.4         0.3 setosa 
##  8          5           3.4   1.5         0.2 setosa 
##  9          4.4         2.9   1.4         0.2 setosa 
## 10          4.9         3.1   1.5         0.1 setosa 
## # … with 140 more rows
```
]
]
.pull-right[
.small[


```r
iris |&gt; as_tibble() |&gt; 
  rename_with(~str_replace_all(.x, "[(a-z.)]", ""), .cols = matches("(Pet)|(Sep)"))
```

```
## # A tibble: 150 x 5
##       SL    SW    PL    PW Species
##    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;fct&gt;  
##  1   5.1   3.5   1.4   0.2 setosa 
##  2   4.9   3     1.4   0.2 setosa 
##  3   4.7   3.2   1.3   0.2 setosa 
##  4   4.6   3.1   1.5   0.2 setosa 
##  5   5     3.6   1.4   0.2 setosa 
##  6   5.4   3.9   1.7   0.4 setosa 
##  7   4.6   3.4   1.4   0.3 setosa 
##  8   5     3.4   1.5   0.2 setosa 
##  9   4.4   2.9   1.4   0.2 setosa 
## 10   4.9   3.1   1.5   0.1 setosa 
## # … with 140 more rows
```
]
]

]
.panel[.panel-name[pull()]
.small[


```r
iris |&gt; as_tibble() |&gt; pull(Species)
```

```
##   [1] setosa     setosa     setosa     setosa     setosa     setosa     setosa     setosa     setosa     setosa    
##  [11] setosa     setosa     setosa     setosa     setosa     setosa     setosa     setosa     setosa     setosa    
##  [21] setosa     setosa     setosa     setosa     setosa     setosa     setosa     setosa     setosa     setosa    
##  [31] setosa     setosa     setosa     setosa     setosa     setosa     setosa     setosa     setosa     setosa    
##  [41] setosa     setosa     setosa     setosa     setosa     setosa     setosa     setosa     setosa     setosa    
##  [51] versicolor versicolor versicolor versicolor versicolor versicolor versicolor versicolor versicolor versicolor
##  [61] versicolor versicolor versicolor versicolor versicolor versicolor versicolor versicolor versicolor versicolor
##  [71] versicolor versicolor versicolor versicolor versicolor versicolor versicolor versicolor versicolor versicolor
##  [81] versicolor versicolor versicolor versicolor versicolor versicolor versicolor versicolor versicolor versicolor
##  [91] versicolor versicolor versicolor versicolor versicolor versicolor versicolor versicolor versicolor versicolor
## [101] virginica  virginica  virginica  virginica  virginica  virginica  virginica  virginica  virginica  virginica 
## [111] virginica  virginica  virginica  virginica  virginica  virginica  virginica  virginica  virginica  virginica 
## [121] virginica  virginica  virginica  virginica  virginica  virginica  virginica  virginica  virginica  virginica 
## [131] virginica  virginica  virginica  virginica  virginica  virginica  virginica  virginica  virginica  virginica 
## [141] virginica  virginica  virginica  virginica  virginica  virginica  virginica  virginica  virginica  virginica 
## Levels: setosa versicolor virginica
```
]

]
.panel[.panel-name[relocate()]
.pull-left[
.small[


```r
iris |&gt; as_tibble() |&gt; relocate(Species, .before = "Sepal.Length")
```

```
## # A tibble: 150 x 5
##    Species Sepal.Length Sepal.Width Petal.Length Petal.Width
##    &lt;fct&gt;          &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt;
##  1 setosa           5.1         3.5          1.4         0.2
##  2 setosa           4.9         3            1.4         0.2
##  3 setosa           4.7         3.2          1.3         0.2
##  4 setosa           4.6         3.1          1.5         0.2
##  5 setosa           5           3.6          1.4         0.2
##  6 setosa           5.4         3.9          1.7         0.4
##  7 setosa           4.6         3.4          1.4         0.3
##  8 setosa           5           3.4          1.5         0.2
##  9 setosa           4.4         2.9          1.4         0.2
## 10 setosa           4.9         3.1          1.5         0.1
## # … with 140 more rows
```
]
]

.pull-right[
.small[

```r
iris |&gt; as_tibble() |&gt; relocate(Species, matches("Length"), .before = "Sepal.Length")
```

```
## # A tibble: 150 x 5
##    Species Sepal.Length Petal.Length Sepal.Width Petal.Width
##    &lt;fct&gt;          &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;
##  1 setosa           5.1          1.4         3.5         0.2
##  2 setosa           4.9          1.4         3           0.2
##  3 setosa           4.7          1.3         3.2         0.2
##  4 setosa           4.6          1.5         3.1         0.2
##  5 setosa           5            1.4         3.6         0.2
##  6 setosa           5.4          1.7         3.9         0.4
##  7 setosa           4.6          1.4         3.4         0.3
##  8 setosa           5            1.5         3.4         0.2
##  9 setosa           4.4          1.4         2.9         0.2
## 10 setosa           4.9          1.5         3.1         0.1
## # … with 140 more rows
```
]
]

]
]

---

## 行の加工

.panelset[
.panel[.panel-name[filter()]
.pull-left[
.small[


```r
iris |&gt; as_tibble() |&gt; filter(str_detect(Species, "versicolor"))
```

```
## # A tibble: 50 x 5
##    Sepal.Length Sepal.Width Petal.Length Petal.Width Species   
##           &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;     
##  1          7           3.2          4.7         1.4 versicolor
##  2          6.4         3.2          4.5         1.5 versicolor
##  3          6.9         3.1          4.9         1.5 versicolor
##  4          5.5         2.3          4           1.3 versicolor
##  5          6.5         2.8          4.6         1.5 versicolor
##  6          5.7         2.8          4.5         1.3 versicolor
##  7          6.3         3.3          4.7         1.6 versicolor
##  8          4.9         2.4          3.3         1   versicolor
##  9          6.6         2.9          4.6         1.3 versicolor
## 10          5.2         2.7          3.9         1.4 versicolor
## # … with 40 more rows
```
]
]
.pull-right[

.small[

```r
iris |&gt; as_tibble() |&gt; filter(Petal.Length &gt; 6 &amp; Sepal.Length &gt; 7.5)
```

```
## # A tibble: 6 x 5
##   Sepal.Length Sepal.Width Petal.Length Petal.Width Species  
##          &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;    
## 1          7.6         3            6.6         2.1 virginica
## 2          7.7         3.8          6.7         2.2 virginica
## 3          7.7         2.6          6.9         2.3 virginica
## 4          7.7         2.8          6.7         2   virginica
## 5          7.9         3.8          6.4         2   virginica
## 6          7.7         3            6.1         2.3 virginica
```
]]]
.panel[.panel-name[distinct()]
.pull-left[

```r
iris |&gt; as_tibble() |&gt; distinct(Species)
```

```
## # A tibble: 3 x 1
##   Species   
##   &lt;fct&gt;     
## 1 setosa    
## 2 versicolor
## 3 virginica
```
]
.pull-right[
.small[

```r
iris |&gt; as_tibble() |&gt; distinct(Petal.Length, .keep_all = T)
```

```
## # A tibble: 43 x 5
##    Sepal.Length Sepal.Width Petal.Length Petal.Width Species   
##           &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;     
##  1          5.1         3.5          1.4         0.2 setosa    
##  2          4.7         3.2          1.3         0.2 setosa    
##  3          4.6         3.1          1.5         0.2 setosa    
##  4          5.4         3.9          1.7         0.4 setosa    
##  5          4.8         3.4          1.6         0.2 setosa    
##  6          4.3         3            1.1         0.1 setosa    
##  7          5.8         4            1.2         0.2 setosa    
##  8          4.6         3.6          1           0.2 setosa    
##  9          4.8         3.4          1.9         0.2 setosa    
## 10          7           3.2          4.7         1.4 versicolor
## # … with 33 more rows
```
]]]
.panel[.panel-name[slice()]
.pull-left[
.small[

```r
iris |&gt; as_tibble() |&gt; slice(1:5)
```

```
## # A tibble: 5 x 5
##   Sepal.Length Sepal.Width Petal.Length Petal.Width Species
##          &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;  
## 1          5.1         3.5          1.4         0.2 setosa 
## 2          4.9         3            1.4         0.2 setosa 
## 3          4.7         3.2          1.3         0.2 setosa 
## 4          4.6         3.1          1.5         0.2 setosa 
## 5          5           3.6          1.4         0.2 setosa
```

```r
iris |&gt; as_tibble() |&gt; slice_head(n = 2)
```

```
## # A tibble: 2 x 5
##   Sepal.Length Sepal.Width Petal.Length Petal.Width Species
##          &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;  
## 1          5.1         3.5          1.4         0.2 setosa 
## 2          4.9         3            1.4         0.2 setosa
```

```r
iris |&gt; as_tibble() |&gt; slice_tail(n = 2)
```

```
## # A tibble: 2 x 5
##   Sepal.Length Sepal.Width Petal.Length Petal.Width Species  
##          &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;    
## 1          6.2         3.4          5.4         2.3 virginica
## 2          5.9         3            5.1         1.8 virginica
```
]]
.pull-right[
.small[

```r
iris |&gt; as_tibble() |&gt; slice_min(Petal.Length)
```

```
## # A tibble: 1 x 5
##   Sepal.Length Sepal.Width Petal.Length Petal.Width Species
##          &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;  
## 1          4.6         3.6            1         0.2 setosa
```

```r
iris |&gt; as_tibble() |&gt; slice_max(Petal.Length)
```

```
## # A tibble: 1 x 5
##   Sepal.Length Sepal.Width Petal.Length Petal.Width Species  
##          &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;    
## 1          7.7         2.6          6.9         2.3 virginica
```

```r
iris |&gt; as_tibble() |&gt; slice_sample(n = 3)
```

```
## # A tibble: 3 x 5
##   Sepal.Length Sepal.Width Petal.Length Petal.Width Species   
##          &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;     
## 1          6.3         3.3          6           2.5 virginica 
## 2          6           3.4          4.5         1.6 versicolor
## 3          6.2         2.9          4.3         1.3 versicolor
```
]]]
.panel[.panel-name[arrange()]
.pull-left[
.small[

```r
iris |&gt; as_tibble() |&gt; arrange(Sepal.Length)
```

```
## # A tibble: 150 x 5
##    Sepal.Length Sepal.Width Petal.Length Petal.Width Species
##           &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;  
##  1          4.3         3            1.1         0.1 setosa 
##  2          4.4         2.9          1.4         0.2 setosa 
##  3          4.4         3            1.3         0.2 setosa 
##  4          4.4         3.2          1.3         0.2 setosa 
##  5          4.5         2.3          1.3         0.3 setosa 
##  6          4.6         3.1          1.5         0.2 setosa 
##  7          4.6         3.4          1.4         0.3 setosa 
##  8          4.6         3.6          1           0.2 setosa 
##  9          4.6         3.2          1.4         0.2 setosa 
## 10          4.7         3.2          1.3         0.2 setosa 
## # … with 140 more rows
```
]]
.pull-right[
.small[

```r
iris |&gt; as_tibble() |&gt; 
  arrange(desc(Sepal.Length), desc(Sepal.Width))
```

```
## # A tibble: 150 x 5
##    Sepal.Length Sepal.Width Petal.Length Petal.Width Species  
##           &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;    
##  1          7.9         3.8          6.4         2   virginica
##  2          7.7         3.8          6.7         2.2 virginica
##  3          7.7         3            6.1         2.3 virginica
##  4          7.7         2.8          6.7         2   virginica
##  5          7.7         2.6          6.9         2.3 virginica
##  6          7.6         3            6.6         2.1 virginica
##  7          7.4         2.8          6.1         1.9 virginica
##  8          7.3         2.9          6.3         1.8 virginica
##  9          7.2         3.6          6.1         2.5 virginica
## 10          7.2         3.2          6           1.8 virginica
## # … with 140 more rows
```
]]]
]

---

## グループ化・ネストに関する関数

* `group_by()`：`tibble` をグループ化する
* `group_nest()`：グループ化した `tibble` をネスト（入れ子）する
* `nest()`：渡した列をネストする
* `unnest()`：ネストされている列を展開（アンネスト）する
* `group_map()`：グループ化した `tibble` に関数を適応して、リストを返す
* `group_modify()`：グループ化した `tibble` に関数を適応して、tibble を返す

---

## `tibble` のグループ化

.panelset[
.panel[.panel-name[group_by()]
.pull-left[

```r
iris |&gt; as_tibble() |&gt; select(1:3)
```

```
## # A tibble: 150 x 3
##    Sepal.Length Sepal.Width Petal.Length
##           &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;
##  1          5.1         3.5          1.4
##  2          4.9         3            1.4
##  3          4.7         3.2          1.3
##  4          4.6         3.1          1.5
##  5          5           3.6          1.4
##  6          5.4         3.9          1.7
##  7          4.6         3.4          1.4
##  8          5           3.4          1.5
##  9          4.4         2.9          1.4
## 10          4.9         3.1          1.5
## # … with 140 more rows
```
]

.pull-right[
.small[


```r
iris |&gt; as_tibble() |&gt; group_by(Species) |&gt; select(1:3)
```

```
## # A tibble: 150 x 4
## # Groups:   Species [3]
##    Species Sepal.Length Sepal.Width Petal.Length
##    &lt;fct&gt;          &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;
##  1 setosa           5.1         3.5          1.4
##  2 setosa           4.9         3            1.4
##  3 setosa           4.7         3.2          1.3
##  4 setosa           4.6         3.1          1.5
##  5 setosa           5           3.6          1.4
##  6 setosa           5.4         3.9          1.7
##  7 setosa           4.6         3.4          1.4
##  8 setosa           5           3.4          1.5
##  9 setosa           4.4         2.9          1.4
## 10 setosa           4.9         3.1          1.5
## # … with 140 more rows
```
]]]

.panel[.panel-name[group_nest()]
.small[

```r
iris |&gt; as_tibble() |&gt; group_nest(Species)
```

```
## # A tibble: 3 x 2
##   Species                  data
##   &lt;fct&gt;      &lt;list&lt;tibble[,4]&gt;&gt;
## 1 setosa               [50 × 4]
## 2 versicolor           [50 × 4]
## 3 virginica            [50 × 4]
```
]]

.panel[.panel-name[nest()]
.small[

```r
iris |&gt; as_tibble() |&gt; nest(data = matches("Length|Width"))
```

```
## # A tibble: 3 x 2
##   Species    data             
##   &lt;fct&gt;      &lt;list&gt;           
## 1 setosa     &lt;tibble [50 × 4]&gt;
## 2 versicolor &lt;tibble [50 × 4]&gt;
## 3 virginica  &lt;tibble [50 × 4]&gt;
```
]]

.panel[.panel-name[unnest()]
.small[

```r
iris |&gt; as_tibble() |&gt; group_nest(Species) |&gt; unnest(data)
```

```
## # A tibble: 150 x 5
##    Species Sepal.Length Sepal.Width Petal.Length Petal.Width
##    &lt;fct&gt;          &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt;
##  1 setosa           5.1         3.5          1.4         0.2
##  2 setosa           4.9         3            1.4         0.2
##  3 setosa           4.7         3.2          1.3         0.2
##  4 setosa           4.6         3.1          1.5         0.2
##  5 setosa           5           3.6          1.4         0.2
##  6 setosa           5.4         3.9          1.7         0.4
##  7 setosa           4.6         3.4          1.4         0.3
##  8 setosa           5           3.4          1.5         0.2
##  9 setosa           4.4         2.9          1.4         0.2
## 10 setosa           4.9         3.1          1.5         0.1
## # … with 140 more rows
```
]]
.panel[.panel-name[group_map()]
.small[

```r
iris |&gt; as_tibble() |&gt; group_by(Species) |&gt; group_map(~head(.x, n = 2))
```

```
## [[1]]
## # A tibble: 2 x 4
##   Sepal.Length Sepal.Width Petal.Length Petal.Width
##          &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt;
## 1          5.1         3.5          1.4         0.2
## 2          4.9         3            1.4         0.2
## 
## [[2]]
## # A tibble: 2 x 4
##   Sepal.Length Sepal.Width Petal.Length Petal.Width
##          &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt;
## 1          7           3.2          4.7         1.4
## 2          6.4         3.2          4.5         1.5
## 
## [[3]]
## # A tibble: 2 x 4
##   Sepal.Length Sepal.Width Petal.Length Petal.Width
##          &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt;
## 1          6.3         3.3          6           2.5
## 2          5.8         2.7          5.1         1.9
```
]]
.panel[.panel-name[group_modify()]
.small[

```r
iris |&gt; as_tibble() |&gt; group_by(Species) |&gt; group_modify(~head(.x, n = 2))
```

```
## # A tibble: 6 x 5
## # Groups:   Species [3]
##   Species    Sepal.Length Sepal.Width Petal.Length Petal.Width
##   &lt;fct&gt;             &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt;
## 1 setosa              5.1         3.5          1.4         0.2
## 2 setosa              4.9         3            1.4         0.2
## 3 versicolor          7           3.2          4.7         1.4
## 4 versicolor          6.4         3.2          4.5         1.5
## 5 virginica           6.3         3.3          6           2.5
## 6 virginica           5.8         2.7          5.1         1.9
```
]]
]

---

## その他の関数

.pull-left[
* `drop_na()`：`NA`（欠損値）を含む行を削除
* `replace_na()`：`NA`を他の値と書き換える
* `fill()`：`NA`を直前の値で埋める
]
.pull-right[
* `separate()`：文字列の変数を任意の区切りで複数変数に分裂する
* `unite()`：複数の変数を任意の区切りで 1 列にまとめる
]


.panelset[
.panel[.panel-name[drop_na()]
.pull-left[

```r
X
```

```
## # A tibble: 4 x 2
##   x         y
##   &lt;chr&gt; &lt;dbl&gt;
## 1 A     NA   
## 2 B      3.92
## 3 C      4.73
## 4 G      5.18
```
]
.pull-right[

```r
X |&gt; drop_na()
```

```
## # A tibble: 3 x 2
##   x         y
##   &lt;chr&gt; &lt;dbl&gt;
## 1 B      3.92
## 2 C      4.73
## 3 G      5.18
```
]
]
.panel[.panel-name[replace_na()]
.pull-left[

```r
X |&gt; replace_na(list(x = "Z", y = 0))
```

```
## # A tibble: 4 x 2
##   x         y
##   &lt;chr&gt; &lt;dbl&gt;
## 1 A      0   
## 2 B      3.92
## 3 C      4.73
## 4 G      5.18
```
]
.pull-right[

```r
X |&gt; mutate(y = replace_na(y, 0))
```

```
## # A tibble: 4 x 2
##   x         y
##   &lt;chr&gt; &lt;dbl&gt;
## 1 A      0   
## 2 B      3.92
## 3 C      4.73
## 4 G      5.18
```

]
]
.panel[.panel-name[fill()]

```r
Y |&gt; fill(z)
```

```
## # A tibble: 4 x 2
##   x         z
##   &lt;chr&gt; &lt;int&gt;
## 1 A         9
## 2 C         8
## 3 D         9
## 4 E         9
```
]
.panel[.panel-name[separate()]

```r
tibble(x = c(NA, "Iris.setosa", "Iris.virginica", "Iris.versicolor")) |&gt; 
  separate(x, into = c("Genus", "Species"))
```

```
## # A tibble: 4 x 2
##   Genus Species   
##   &lt;chr&gt; &lt;chr&gt;     
## 1 &lt;NA&gt;  &lt;NA&gt;      
## 2 Iris  setosa    
## 3 Iris  virginica 
## 4 Iris  versicolor
```
]
.panel[.panel-name[unite()]

```r
tibble(x = rep("Iris", 3), y = c("setosa", "virginica", "versicolor")) |&gt; 
  unite(Species, x, y, sep = "_")
```

```
## # A tibble: 3 x 1
##   Species        
##   &lt;chr&gt;          
## 1 Iris_setosa    
## 2 Iris_virginica 
## 3 Iris_versicolor
```
]
]

---

## ピボット・`tibble`を変形する関数

* `pivot_longer()`：`tibble` を wide format （横広）から long format （縦長）に変える
* `pivot_wider()`：`tibble` をlong format から wide format に変える

-------------------

### 重要な引数

.pull-left[
`pivot_longer()`

* `cols`：動かす変数
* `names_to`：動かした変数の名前の移動先
* `values_to`：動かした変数の値の移動先
* `names_transform`：移動先の変数のタイプを変換

]
.pull-right[
`pivot_wider()`

* `id_cols`：行（値）を区別するための列名
* `names_from`：移動先の列名になる変数
* `values_from`：移動したい値
* `values_fill`：存在しない要素の埋め込み方法
* `values_fn`：行の区別ができないときの処理（デフォルトはリスト）

]


---

## `pivot_longer()` の使い方

.panelset[
.panel[.panel-name[pivot_longer() 1]
.pull-left[
.small[

```r
relig_income |&gt; as_tibble()
```

```
## # A tibble: 18 x 11
##    religion    `&lt;$10k` `$10-20k` `$20-30k` `$30-40k` `$40-50k` `$50-75k` `$75-100k` `$100-150k` `&gt;150k` `Don't know/ref…
##    &lt;chr&gt;         &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;       &lt;dbl&gt;   &lt;dbl&gt;            &lt;dbl&gt;
##  1 Agnostic         27        34        60        81        76       137        122         109      84               96
##  2 Atheist          12        27        37        52        35        70         73          59      74               76
##  3 Buddhist         27        21        30        34        33        58         62          39      53               54
##  4 Catholic        418       617       732       670       638      1116        949         792     633             1489
##  5 Don’t know…      15        14        15        11        10        35         21          17      18              116
##  6 Evangelica…     575       869      1064       982       881      1486        949         723     414             1529
##  7 Hindu             1         9         7         9        11        34         47          48      54               37
##  8 Historical…     228       244       236       238       197       223        131          81      78              339
##  9 Jehovah's …      20        27        24        24        21        30         15          11       6               37
## 10 Jewish           19        19        25        25        30        95         69          87     151              162
## 11 Mainline P…     289       495       619       655       651      1107        939         753     634             1328
## 12 Mormon           29        40        48        51        56       112         85          49      42               69
## 13 Muslim            6         7         9        10         9        23         16           8       6               22
## 14 Orthodox         13        17        23        32        32        47         38          42      46               73
## 15 Other Chri…       9         7        11        13        13        14         18          14      12               18
## 16 Other Fait…      20        33        40        46        49        63         46          40      41               71
## 17 Other Worl…       5         2         3         4         2         7          3           4       4                8
## 18 Unaffiliat…     217       299       374       365       341       528        407         321     258              597
```
]]

.pull-right[
.small[

```r
relig_income |&gt; as_tibble() |&gt; 
pivot_longer(!religion, names_to = "income", values_to = "count")
```

```
## # A tibble: 180 x 3
##    religion income             count
##    &lt;chr&gt;    &lt;chr&gt;              &lt;dbl&gt;
##  1 Agnostic &lt;$10k                 27
##  2 Agnostic $10-20k               34
##  3 Agnostic $20-30k               60
##  4 Agnostic $30-40k               81
##  5 Agnostic $40-50k               76
##  6 Agnostic $50-75k              137
##  7 Agnostic $75-100k             122
##  8 Agnostic $100-150k            109
##  9 Agnostic &gt;150k                 84
## 10 Agnostic Don't know/refused    96
## # … with 170 more rows
```
]]]

.panel[.panel-name[pivot_longer() 2]
.pull-left[
.small[

```r
billboard |&gt; as_tibble()
```

```
## # A tibble: 317 x 79
##    artist  track  date.entered   wk1   wk2   wk3   wk4   wk5   wk6   wk7   wk8   wk9  wk10  wk11  wk12  wk13  wk14  wk15
##    &lt;chr&gt;   &lt;chr&gt;  &lt;date&gt;       &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1 2 Pac   Baby … 2000-02-26      87    82    72    77    87    94    99    NA    NA    NA    NA    NA    NA    NA    NA
##  2 2Ge+her The H… 2000-09-02      91    87    92    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA
##  3 3 Door… Krypt… 2000-04-08      81    70    68    67    66    57    54    53    51    51    51    51    47    44    38
##  4 3 Door… Loser  2000-10-21      76    76    72    69    67    65    55    59    62    61    61    59    61    66    72
##  5 504 Bo… Wobbl… 2000-04-15      57    34    25    17    17    31    36    49    53    57    64    70    75    76    78
##  6 98^0    Give … 2000-08-19      51    39    34    26    26    19     2     2     3     6     7    22    29    36    47
##  7 A*Teens Danci… 2000-07-08      97    97    96    95   100    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA
##  8 Aaliyah I Don… 2000-01-29      84    62    51    41    38    35    35    38    38    36    37    37    38    49    61
##  9 Aaliyah Try A… 2000-03-18      59    53    38    28    21    18    16    14    12    10     9     8     6     1     2
## 10 Adams,… Open … 2000-08-26      76    76    74    69    68    67    61    58    57    59    66    68    61    67    59
## # … with 307 more rows, and 61 more variables: wk16 &lt;dbl&gt;, wk17 &lt;dbl&gt;, wk18 &lt;dbl&gt;, wk19 &lt;dbl&gt;, wk20 &lt;dbl&gt;, wk21 &lt;dbl&gt;,
## #   wk22 &lt;dbl&gt;, wk23 &lt;dbl&gt;, wk24 &lt;dbl&gt;, wk25 &lt;dbl&gt;, wk26 &lt;dbl&gt;, wk27 &lt;dbl&gt;, wk28 &lt;dbl&gt;, wk29 &lt;dbl&gt;, wk30 &lt;dbl&gt;,
## #   wk31 &lt;dbl&gt;, wk32 &lt;dbl&gt;, wk33 &lt;dbl&gt;, wk34 &lt;dbl&gt;, wk35 &lt;dbl&gt;, wk36 &lt;dbl&gt;, wk37 &lt;dbl&gt;, wk38 &lt;dbl&gt;, wk39 &lt;dbl&gt;,
## #   wk40 &lt;dbl&gt;, wk41 &lt;dbl&gt;, wk42 &lt;dbl&gt;, wk43 &lt;dbl&gt;, wk44 &lt;dbl&gt;, wk45 &lt;dbl&gt;, wk46 &lt;dbl&gt;, wk47 &lt;dbl&gt;, wk48 &lt;dbl&gt;,
## #   wk49 &lt;dbl&gt;, wk50 &lt;dbl&gt;, wk51 &lt;dbl&gt;, wk52 &lt;dbl&gt;, wk53 &lt;dbl&gt;, wk54 &lt;dbl&gt;, wk55 &lt;dbl&gt;, wk56 &lt;dbl&gt;, wk57 &lt;dbl&gt;,
## #   wk58 &lt;dbl&gt;, wk59 &lt;dbl&gt;, wk60 &lt;dbl&gt;, wk61 &lt;dbl&gt;, wk62 &lt;dbl&gt;, wk63 &lt;dbl&gt;, wk64 &lt;dbl&gt;, wk65 &lt;dbl&gt;, wk66 &lt;lgl&gt;,
## #   wk67 &lt;lgl&gt;, wk68 &lt;lgl&gt;, wk69 &lt;lgl&gt;, wk70 &lt;lgl&gt;, wk71 &lt;lgl&gt;, wk72 &lt;lgl&gt;, wk73 &lt;lgl&gt;, wk74 &lt;lgl&gt;, wk75 &lt;lgl&gt;,
## #   wk76 &lt;lgl&gt;
```
]]
.pull-right[
.small[

```r
billboard |&gt; as_tibble() |&gt; 
  pivot_longer(col = starts_with("wk"),
               names_to = "week", names_prefix = "wk",
               values_to = "rank", values_drop_na = TRUE)
```

```
## # A tibble: 5,307 x 5
##    artist  track                   date.entered week   rank
##    &lt;chr&gt;   &lt;chr&gt;                   &lt;date&gt;       &lt;chr&gt; &lt;dbl&gt;
##  1 2 Pac   Baby Don't Cry (Keep... 2000-02-26   1        87
##  2 2 Pac   Baby Don't Cry (Keep... 2000-02-26   2        82
##  3 2 Pac   Baby Don't Cry (Keep... 2000-02-26   3        72
##  4 2 Pac   Baby Don't Cry (Keep... 2000-02-26   4        77
##  5 2 Pac   Baby Don't Cry (Keep... 2000-02-26   5        87
##  6 2 Pac   Baby Don't Cry (Keep... 2000-02-26   6        94
##  7 2 Pac   Baby Don't Cry (Keep... 2000-02-26   7        99
##  8 2Ge+her The Hardest Part Of ... 2000-09-02   1        91
##  9 2Ge+her The Hardest Part Of ... 2000-09-02   2        87
## 10 2Ge+her The Hardest Part Of ... 2000-09-02   3        92
## # … with 5,297 more rows
```
]]]

.panel[.panel-name[pivot_longer() 3]
.pull-left[
.small[

```r
who |&gt; as_tibble()
```

```
## # A tibble: 7,240 x 60
##    country     iso2  iso3   year new_sp_m014 new_sp_m1524 new_sp_m2534 new_sp_m3544 new_sp_m4554 new_sp_m5564 new_sp_m65
##    &lt;chr&gt;       &lt;chr&gt; &lt;chr&gt; &lt;int&gt;       &lt;int&gt;        &lt;int&gt;        &lt;int&gt;        &lt;int&gt;        &lt;int&gt;        &lt;int&gt;      &lt;int&gt;
##  1 Afghanistan AF    AFG    1980          NA           NA           NA           NA           NA           NA         NA
##  2 Afghanistan AF    AFG    1981          NA           NA           NA           NA           NA           NA         NA
##  3 Afghanistan AF    AFG    1982          NA           NA           NA           NA           NA           NA         NA
##  4 Afghanistan AF    AFG    1983          NA           NA           NA           NA           NA           NA         NA
##  5 Afghanistan AF    AFG    1984          NA           NA           NA           NA           NA           NA         NA
##  6 Afghanistan AF    AFG    1985          NA           NA           NA           NA           NA           NA         NA
##  7 Afghanistan AF    AFG    1986          NA           NA           NA           NA           NA           NA         NA
##  8 Afghanistan AF    AFG    1987          NA           NA           NA           NA           NA           NA         NA
##  9 Afghanistan AF    AFG    1988          NA           NA           NA           NA           NA           NA         NA
## 10 Afghanistan AF    AFG    1989          NA           NA           NA           NA           NA           NA         NA
## # … with 7,230 more rows, and 49 more variables: new_sp_f014 &lt;int&gt;, new_sp_f1524 &lt;int&gt;, new_sp_f2534 &lt;int&gt;,
## #   new_sp_f3544 &lt;int&gt;, new_sp_f4554 &lt;int&gt;, new_sp_f5564 &lt;int&gt;, new_sp_f65 &lt;int&gt;, new_sn_m014 &lt;int&gt;,
## #   new_sn_m1524 &lt;int&gt;, new_sn_m2534 &lt;int&gt;, new_sn_m3544 &lt;int&gt;, new_sn_m4554 &lt;int&gt;, new_sn_m5564 &lt;int&gt;,
## #   new_sn_m65 &lt;int&gt;, new_sn_f014 &lt;int&gt;, new_sn_f1524 &lt;int&gt;, new_sn_f2534 &lt;int&gt;, new_sn_f3544 &lt;int&gt;,
## #   new_sn_f4554 &lt;int&gt;, new_sn_f5564 &lt;int&gt;, new_sn_f65 &lt;int&gt;, new_ep_m014 &lt;int&gt;, new_ep_m1524 &lt;int&gt;,
## #   new_ep_m2534 &lt;int&gt;, new_ep_m3544 &lt;int&gt;, new_ep_m4554 &lt;int&gt;, new_ep_m5564 &lt;int&gt;, new_ep_m65 &lt;int&gt;,
## #   new_ep_f014 &lt;int&gt;, new_ep_f1524 &lt;int&gt;, new_ep_f2534 &lt;int&gt;, new_ep_f3544 &lt;int&gt;, new_ep_f4554 &lt;int&gt;,
## #   new_ep_f5564 &lt;int&gt;, new_ep_f65 &lt;int&gt;, newrel_m014 &lt;int&gt;, newrel_m1524 &lt;int&gt;, newrel_m2534 &lt;int&gt;,
## #   newrel_m3544 &lt;int&gt;, newrel_m4554 &lt;int&gt;, newrel_m5564 &lt;int&gt;, newrel_m65 &lt;int&gt;, newrel_f014 &lt;int&gt;,
## #   newrel_f1524 &lt;int&gt;, newrel_f2534 &lt;int&gt;, newrel_f3544 &lt;int&gt;, newrel_f4554 &lt;int&gt;, newrel_f5564 &lt;int&gt;,
## #   newrel_f65 &lt;int&gt;
```
]]
.pull-right[
.small[

```r
who %&gt;% as_tibble() |&gt;
  pivot_longer(cols = new_sp_m014:newrel_f65,
               names_to = c("diagnosis", "gender", "age"),
               names_pattern = "new_?(.*)_(.)(.*)",
               values_to = "count", values_drop_na = TRUE)
```

```
## # A tibble: 76,046 x 8
##    country     iso2  iso3   year diagnosis gender age   count
##    &lt;chr&gt;       &lt;chr&gt; &lt;chr&gt; &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;  &lt;chr&gt; &lt;int&gt;
##  1 Afghanistan AF    AFG    1997 sp        m      014       0
##  2 Afghanistan AF    AFG    1997 sp        m      1524     10
##  3 Afghanistan AF    AFG    1997 sp        m      2534      6
##  4 Afghanistan AF    AFG    1997 sp        m      3544      3
##  5 Afghanistan AF    AFG    1997 sp        m      4554      5
##  6 Afghanistan AF    AFG    1997 sp        m      5564      2
##  7 Afghanistan AF    AFG    1997 sp        m      65        0
##  8 Afghanistan AF    AFG    1997 sp        f      014       5
##  9 Afghanistan AF    AFG    1997 sp        f      1524     38
## 10 Afghanistan AF    AFG    1997 sp        f      2534     36
## # … with 76,036 more rows
```
]]]

.panel[.panel-name[pivot_longer() 4]
.pull-left[
.small[

```r
anscombe |&gt; as_tibble()
```

```
## # A tibble: 11 x 8
##       x1    x2    x3    x4    y1    y2    y3    y4
##    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1    10    10    10     8  8.04  9.14  7.46  6.58
##  2     8     8     8     8  6.95  8.14  6.77  5.76
##  3    13    13    13     8  7.58  8.74 12.7   7.71
##  4     9     9     9     8  8.81  8.77  7.11  8.84
##  5    11    11    11     8  8.33  9.26  7.81  8.47
##  6    14    14    14     8  9.96  8.1   8.84  7.04
##  7     6     6     6     8  7.24  6.13  6.08  5.25
##  8     4     4     4    19  4.26  3.1   5.39 12.5 
##  9    12    12    12     8 10.8   9.13  8.15  5.56
## 10     7     7     7     8  4.82  7.26  6.42  7.91
## 11     5     5     5     8  5.68  4.74  5.73  6.89
```
]]
.pull-right[
.small[

```r
anscombe %&gt;% as_tibble() |&gt; 
 pivot_longer(everything(), names_to = c(".value", "set"), names_pattern = "(.)(.)"
 )
```

```
## # A tibble: 44 x 3
##    set       x     y
##    &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1 1        10  8.04
##  2 2        10  9.14
##  3 3        10  7.46
##  4 4         8  6.58
##  5 1         8  6.95
##  6 2         8  8.14
##  7 3         8  6.77
##  8 4         8  5.76
##  9 1        13  7.58
## 10 2        13  8.74
## # … with 34 more rows
```
]]]
]


---

## `pivot_wider()` の使い方

.panelset[
.panel[.panel-name[pivot_longer() 1]
.pull-left[
.small[

```r
fish_encounters
```

```
## # A tibble: 114 x 3
##    fish  station  seen
##    &lt;fct&gt; &lt;fct&gt;   &lt;int&gt;
##  1 4842  Release     1
##  2 4842  I80_1       1
##  3 4842  Lisbon      1
##  4 4842  Rstr        1
##  5 4842  Base_TD     1
##  6 4842  BCE         1
##  7 4842  BCW         1
##  8 4842  BCE2        1
##  9 4842  BCW2        1
## 10 4842  MAE         1
## # … with 104 more rows
```
]]

.pull-right[
.small[

```r
fish_encounters |&gt; as_tibble() |&gt; 
  pivot_wider(names_from = station, values_from = seen)
```

```
## # A tibble: 19 x 12
##    fish  Release I80_1 Lisbon  Rstr Base_TD   BCE   BCW  BCE2  BCW2   MAE   MAW
##    &lt;fct&gt;   &lt;int&gt; &lt;int&gt;  &lt;int&gt; &lt;int&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;
##  1 4842        1     1      1     1       1     1     1     1     1     1     1
##  2 4843        1     1      1     1       1     1     1     1     1     1     1
##  3 4844        1     1      1     1       1     1     1     1     1     1     1
##  4 4845        1     1      1     1       1    NA    NA    NA    NA    NA    NA
##  5 4847        1     1      1    NA      NA    NA    NA    NA    NA    NA    NA
##  6 4848        1     1      1     1      NA    NA    NA    NA    NA    NA    NA
##  7 4849        1     1     NA    NA      NA    NA    NA    NA    NA    NA    NA
##  8 4850        1     1     NA     1       1     1     1    NA    NA    NA    NA
##  9 4851        1     1     NA    NA      NA    NA    NA    NA    NA    NA    NA
## 10 4854        1     1     NA    NA      NA    NA    NA    NA    NA    NA    NA
## 11 4855        1     1      1     1       1    NA    NA    NA    NA    NA    NA
## 12 4857        1     1      1     1       1     1     1     1     1    NA    NA
## 13 4858        1     1      1     1       1     1     1     1     1     1     1
## 14 4859        1     1      1     1       1    NA    NA    NA    NA    NA    NA
## 15 4861        1     1      1     1       1     1     1     1     1     1     1
## 16 4862        1     1      1     1       1     1     1     1     1    NA    NA
## 17 4863        1     1     NA    NA      NA    NA    NA    NA    NA    NA    NA
## 18 4864        1     1     NA    NA      NA    NA    NA    NA    NA    NA    NA
## 19 4865        1     1      1    NA      NA    NA    NA    NA    NA    NA    NA
```
]]]

.panel[.panel-name[pivot_longer() 2]
.pull-left[
.small[

```r
fish_encounters
```

```
## # A tibble: 114 x 3
##    fish  station  seen
##    &lt;fct&gt; &lt;fct&gt;   &lt;int&gt;
##  1 4842  Release     1
##  2 4842  I80_1       1
##  3 4842  Lisbon      1
##  4 4842  Rstr        1
##  5 4842  Base_TD     1
##  6 4842  BCE         1
##  7 4842  BCW         1
##  8 4842  BCE2        1
##  9 4842  BCW2        1
## 10 4842  MAE         1
## # … with 104 more rows
```
]]

.pull-right[
.small[

```r
# 存在しない組み合わせの要素を埋める
fish_encounters |&gt;  as_tibble() |&gt; 
  pivot_wider(names_from = station, values_from = seen, values_fill = 0)
```

```
## # A tibble: 19 x 12
##    fish  Release I80_1 Lisbon  Rstr Base_TD   BCE   BCW  BCE2  BCW2   MAE   MAW
##    &lt;fct&gt;   &lt;int&gt; &lt;int&gt;  &lt;int&gt; &lt;int&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;
##  1 4842        1     1      1     1       1     1     1     1     1     1     1
##  2 4843        1     1      1     1       1     1     1     1     1     1     1
##  3 4844        1     1      1     1       1     1     1     1     1     1     1
##  4 4845        1     1      1     1       1     0     0     0     0     0     0
##  5 4847        1     1      1     0       0     0     0     0     0     0     0
##  6 4848        1     1      1     1       0     0     0     0     0     0     0
##  7 4849        1     1      0     0       0     0     0     0     0     0     0
##  8 4850        1     1      0     1       1     1     1     0     0     0     0
##  9 4851        1     1      0     0       0     0     0     0     0     0     0
## 10 4854        1     1      0     0       0     0     0     0     0     0     0
## 11 4855        1     1      1     1       1     0     0     0     0     0     0
## 12 4857        1     1      1     1       1     1     1     1     1     0     0
## 13 4858        1     1      1     1       1     1     1     1     1     1     1
## 14 4859        1     1      1     1       1     0     0     0     0     0     0
## 15 4861        1     1      1     1       1     1     1     1     1     1     1
## 16 4862        1     1      1     1       1     1     1     1     1     0     0
## 17 4863        1     1      0     0       0     0     0     0     0     0     0
## 18 4864        1     1      0     0       0     0     0     0     0     0     0
## 19 4865        1     1      1     0       0     0     0     0     0     0     0
```
]]]

.panel[.panel-name[pivot_longer() 3]
.pull-left[
.small[

```r
us_rent_income |&gt; as_tibble()
```

```
## # A tibble: 104 x 5
##    GEOID NAME       variable estimate   moe
##    &lt;chr&gt; &lt;chr&gt;      &lt;chr&gt;       &lt;dbl&gt; &lt;dbl&gt;
##  1 01    Alabama    income      24476   136
##  2 01    Alabama    rent          747     3
##  3 02    Alaska     income      32940   508
##  4 02    Alaska     rent         1200    13
##  5 04    Arizona    income      27517   148
##  6 04    Arizona    rent          972     4
##  7 05    Arkansas   income      23789   165
##  8 05    Arkansas   rent          709     5
##  9 06    California income      29454   109
## 10 06    California rent         1358     3
## # … with 94 more rows
```
]]
.pull-right[
.small[

```r
us_rent_income |&gt; as_tibble() |&gt; 
  pivot_wider(names_from = variable, values_from = c(estimate, moe))
```

```
## # A tibble: 52 x 6
##    GEOID NAME                 estimate_income estimate_rent moe_income moe_rent
##    &lt;chr&gt; &lt;chr&gt;                          &lt;dbl&gt;         &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;
##  1 01    Alabama                        24476           747        136        3
##  2 02    Alaska                         32940          1200        508       13
##  3 04    Arizona                        27517           972        148        4
##  4 05    Arkansas                       23789           709        165        5
##  5 06    California                     29454          1358        109        3
##  6 08    Colorado                       32401          1125        109        5
##  7 09    Connecticut                    35326          1123        195        5
##  8 10    Delaware                       31560          1076        247       10
##  9 11    District of Columbia           43198          1424        681       17
## 10 12    Florida                        25952          1077         70        3
## # … with 42 more rows
```

```r
# us_rent_income  |&gt; as_tibble() |&gt; 
#   pivot_wider(names_from = variable,
#               names_sep = ".",
#               values_from = c(estimate, moe))

# us_rent_income  |&gt; as_tibble() |&gt; 
#   pivot_wider(names_from = variable,
#               names_glue = "{variable}_{.value}",
#               values_from = c(estimate, moe))
```
]]]

.panel[.panel-name[pivot_longer() 4]
.pull-left[
.small[

```r
warpbreaks |&gt; as_tibble()
```

```
## # A tibble: 54 x 3
##    breaks wool  tension
##     &lt;dbl&gt; &lt;fct&gt; &lt;fct&gt;  
##  1     26 A     L      
##  2     30 A     L      
##  3     54 A     L      
##  4     25 A     L      
##  5     70 A     L      
##  6     52 A     L      
##  7     51 A     L      
##  8     26 A     L      
##  9     67 A     L      
## 10     18 A     M      
## # … with 44 more rows
```
]]
.pull-right[
.small[

```r
warpbreaks |&gt; as_tibble() |&gt; 
  pivot_wider(names_from = wool,
              values_from = breaks)
```

```
## # A tibble: 3 x 3
##   tension A         B        
##   &lt;fct&gt;   &lt;list&gt;    &lt;list&gt;   
## 1 L       &lt;dbl [9]&gt; &lt;dbl [9]&gt;
## 2 M       &lt;dbl [9]&gt; &lt;dbl [9]&gt;
## 3 H       &lt;dbl [9]&gt; &lt;dbl [9]&gt;
```
]]]

.panel[.panel-name[pivot_longer() 5]
.pull-left[
.small[

```r
warpbreaks |&gt; as_tibble()
```

```
## # A tibble: 54 x 3
##    breaks wool  tension
##     &lt;dbl&gt; &lt;fct&gt; &lt;fct&gt;  
##  1     26 A     L      
##  2     30 A     L      
##  3     54 A     L      
##  4     25 A     L      
##  5     70 A     L      
##  6     52 A     L      
##  7     51 A     L      
##  8     26 A     L      
##  9     67 A     L      
## 10     18 A     M      
## # … with 44 more rows
```
]]

.pull-right[
.small[

```r
warpbreaks |&gt; as_tibble() |&gt; 
  pivot_wider(names_from = wool,
              values_from = breaks,
              values_fn = mean)
```

```
## # A tibble: 3 x 3
##   tension     A     B
##   &lt;fct&gt;   &lt;dbl&gt; &lt;dbl&gt;
## 1 L        44.6  28.2
## 2 M        24    28.8
## 3 H        24.6  18.8
```
]]]
]


---

## 不都合なデータ構造





```r
fname = "photosynthesis1_low.csv"
dset1_low = read_csv(fname)
```



```r
dset1_low
```

```
## # A tibble: 35 x 12
##    sample   min   `0`   `5`  `10`  `15`  `20`  `25`  `30`  `35`  `40`  `45`
##     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1      1     0  9.99 10.1  10.0  10.0  10.1   9.81 10.0  10.1  10.0  10.2 
##  2      2     0  9.97  9.99 10.1  10.0   9.99  9.94  9.91  9.95  9.79  9.97
##  3      3     0 10.0  10.1  10.1   9.97 10.1  10.0  10.0  10.0   9.88 10.0 
##  4      4     0 10.0   9.87 10.1   9.87 10.0   9.95 10.2  10.0  10.1  10.1 
##  5      5     0  9.92  9.97  9.88  9.86 10.0   9.91 10.0   9.94 10.0   9.95
##  6      1     5  9.67 10.0   9.93 10.5  10.4  10.7  10.8  10.6  10.7  10.6 
##  7      2     5  9.40  9.87 10.1  10.0  10.4  10.6  10.7  10.6  10.6  10.7 
##  8      3     5  9.37  9.84 10.2  10.3  10.5  10.6  10.5  10.6  10.7  10.7 
##  9      4     5  9.52  9.71  9.92 10.1  10.5  10.5  10.7  10.5  10.7  10.8 
## 10      5     5  9.65  9.83 10.1  10.4  10.4  10.6  10.5  10.5  10.7  10.7 
## # … with 25 more rows
```

`sample` と `min` の列はサンプル番号と時間 (minutes) の変数です。
それぞれに、サンプル番号と時間の値が入っています。
`0` から `45` の列には溶存酸素濃度の値が入っています。
この時の変数名は光条件ですね。

---

## ワイドからロングへ変換


```r
dset1_low |&gt; 
  pivot_longer(cols = matches("[0-9]+"),　names_to = "light",
               names_transform  = list(light = as.numeric))
```

```
## # A tibble: 350 x 4
##    sample   min light value
##     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1      1     0     0  9.99
##  2      1     0     5 10.1 
##  3      1     0    10 10.0 
##  4      1     0    15 10.0 
##  5      1     0    20 10.1 
##  6      1     0    25  9.81
##  7      1     0    30 10.0 
##  8      1     0    35 10.1 
##  9      1     0    40 10.0 
## 10      1     0    45 10.2 
## # … with 340 more rows
```

---

## 残りのデータの読み込み



```r
dset1_high = read_csv("photosynthesis1_high.csv")
dset2_low  = read_csv("photosynthesis2_low.csv")
dset2_high = read_csv("photosynthesis2_high.csv")
```

---

## ピボットしてから結合


```r
dset1_low  = dset1_low  |&gt; pivot_longer(cols = matches("[0-9]+"), names_to = "light", names_transform = list(light = as.numeric))
dset1_high = dset1_high |&gt; pivot_longer(cols = matches("[0-9]+"), names_to = "light", names_transform = list(light = as.numeric))
dset2_low  = dset2_low  |&gt; pivot_longer(cols = matches("[0-9]+"), names_to = "light", names_transform = list(light = as.numeric))
dset2_high = dset2_high |&gt; pivot_longer(cols = matches("[0-9]+"), names_to = "light", names_transform = list(light = as.numeric))
alldata = bind_rows(dset1_low, dset2_low, dset1_high, dset2_high)
alldata
```

```
## # A tibble: 910 x 4
##    sample   min light value
##     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1      1     0     0  9.99
##  2      1     0     5 10.1 
##  3      1     0    10 10.0 
##  4      1     0    15 10.0 
##  5      1     0    20 10.1 
##  6      1     0    25  9.81
##  7      1     0    30 10.0 
##  8      1     0    35 10.1 
##  9      1     0    40 10.0 
## 10      1     0    45 10.2 
## # … with 900 more rows
```

---

## 結合してからピボット




```r
dset1 = full_join(dset1_low, dset1_high, by = c("sample", "min"))
dset2 = full_join(dset2_low, dset2_high, by = c("sample", "min"))
alldata = bind_rows(dset1, dset2)
alldata = alldata |&gt; 
  pivot_longer(cols = matches("[0-9]+"), names_to = "light", 
               names_transform = list(light = as.numeric))
```


---
class: middle, center, inverse
name: ggplot

# `ggplot2` による作図

---

## `ggplot2` について

* `ggplot2` の関数は `+` でつなげる
* `ggplot()` はベースレイヤー
* `geom_*()` はプロットレイヤー
* `scales_*()` でエステティク (aesthetics) を調整
* `theme()` や `theme_()` で書式を調整
* `facet_wrap()` や `facet_grid()` は多変量データのプロットのパネル分け
---

## Aesthetics （エステティク）とは

.pull-left[
### 色・透明度

* `color`：点と線の色
* `fill`：面の色
* `alpha`：透明度（0 -- 1 の値）

### 大きさ・形状

* `size`：点と文字の大きさ、線の太さ
* `shape`：点の形
* `linetype`：線の種類

]

.pull-right[
### グループ化

* `group`：点や線のグループ化

### 座標、始点・終点

* `x`, `y`
* `xmin`, `ymin`
* `xend`, `yend`

]

---

## geom の種類

.pull-left[
**散布図**

* `geom_point()`
* `geom_jitter()`

**折れ線グラフ**

* `geom_path()`
* `geom_line()`
* `geom_step()`

**面グラフ**
* `geom_ribbon()`
* `geom_area()`
* `geom_polygon()`

]

.pull-right[
**ヒートマップ・コンター図**
* `geom_tile()`
* `geom_raster()`
* `geom_rect()`
* `geom_contour()`

**エラーバー**
* `geom_error()`
* `geom_linerange()`
* `geom_pointrange()`
* `geom_crossbar()`
]

---

## geom の種類

.pull-left[
**曲線など**

* `geom_smooth()`
* `geom_curve()`
* `geom_segment()`
* `geom_abline()`
* `geom_hline()`
* `geom_vline()`

**文字列**

* `geom_text()`
* `geom_label()`

**面グラフ**
* `geom_ribbon()`
* `geom_area()`

]

.pull-right[
**ヒストグラム・密度曲線**
* `geom_histogram()`
* `geom_freqpoly()`
* `geom_density()`
* `geom_bin2d()`
* `geom_hex()`
* `geom_dotplot()`

**棒グラフ・箱ひげ図**
* `geom_bar()`
* `geom_col()`
* `geom_boxplot()`
* `geom_violin()`
]

---

## データを読み込んだら、可視化しよう




```r
ggplot(exceldata) + geom_point(aes(x = month, y = temperature1))
```

&lt;img src="introduction_files/figure-html/unnamed-chunk-112-1.png" width="100%" /&gt;

横軸の順序がおかしいですね。軸タイトルも変えたほうがいいですね。

---

## 軸タイトルの関数

軸タイトルや図のタイトルは `labs()` 関数でします。

.panelset[
.panel[.panel-name[Code]

```r
xlabel = "Month"
ylabel = "'Temperature ('*degree*'C)'" # plotmath expression see ?plotmath
ggplot(exceldata) + 
  geom_point(aes(x = month, y = temperature1)) + 
  labs(x = xlabel, 
       y = parse(text = ylabel),
       title = "Monthly mean water temperature") 
```

]

.panel[.panel-name[Output]

&lt;img src="introduction_files/figure-html/unnamed-chunk-113-1.png" width="100%" /&gt;

]
]

---

## 論文用に変える

学術論文に記載する図の場合、図から余計なかざりを外します。
研究室では `ggpubr` の `theme_pubr()` 関数を使っています。

.panelset[
.panel[.panel-name[Code]

```r
library(ggpubr)
xlabel = "Month"
ylabel = "'Temperature ('*degree*'C)'" # plotmath expression see ?plotmath
ggplot(exceldata) + 
  geom_point(aes(x = month, y = temperature1)) + 
  labs(x = parse(text = xlabel), 
       y = parse(text = ylabel))  +
  theme_pubr(base_size = 10)
```

]

.panel[.panel-name[Output]

&lt;img src="introduction_files/figure-html/unnamed-chunk-114-1.png" width="100%" /&gt;

]
]

---

## フォントを指定する

`showtext` パッケージは図にシステムフォントを入れるために使います。
システムフォントの他に、Google のウェッブフォントも使えます。

```r
library(showtext)
```

Google のウェッブフォントは `font_add_google()` を使います。

```r
font_add_google(name = "Noto Sans", family = "notosans")
font_add_google(name = "Noto Sans JP", family = "notosans-jp") # 日本語フォント
```

`notosans` をデフォルトして設定します。

```r
showtext_auto()
theme_replace(text = element_text(family = "notosans"))
```

---

## 月の順序をなおす

もう気づいたと思いますが、横軸の月の順序が間違っています。
`factor()` で、`month` 変数を整えます。

.panelset[
.panel[.panel-name[Code]

```r
# element_text() size is in points (pt)
# 1 pt = 0.35 mm

library(ggpubr)
xlabel = "Month"
ylabel = "'Temperature ('*degree*'C)'" # plotmath expression see ?plotmath

levels = month.abb
levels = str_c(levels, ifelse(levels == "May", "", "."))

exceldata |&gt; 
  mutate(month = factor(month, levels = levels)) |&gt; 
  ggplot() + 
  geom_point(aes(x = month, y = temperature1)) + 
  labs(x = parse(text = xlabel), 
       y = parse(text = ylabel))  +
  theme_pubr(base_family = "notosans") +
  theme(text = element_text(size = 10))
```

]

.panel[.panel-name[Output]

&lt;img src="introduction_files/figure-html/unnamed-chunk-118-1.png" width="100%" /&gt;

]

]




---

## 図を保存する

図は PDF と PNG 形式で保存しましょう。

**PDFファイル**
`ggsave()` は最後の表示した図を書き出しします。
`width` と `height` を指定したら必ず単位も指定しましょう (`units = "mm"`)。
PDFファイルにシステムフォントを埋め込むなら、`device = cairo_pdf`も渡しましょう。


```r
wh = list(width = 80, height = 80) # 図の縦横幅
pdffile = "temperature_plot.pdf"
ggsave(pdffile, width = wh$width, height = wh$height, units = "mm", device = cairo_pdf)
```

**PNGファイル**
直接PNGファイルに保存する場合は、画像の解像度 (`dpi = 300`) も必要です。

```r
pngfile = "temperature_plot.png"
ggsave(pngfile, width = wh$width, height = wh$height, units = "mm", dpi = 300)
```

---

## 保存の結果

&lt;img src="introduction_files/figure-html/unnamed-chunk-122-1.png" width="75%" style="display: block; margin: auto;" /&gt;


* `wh = list(width = 80, height = 80)` は同じだが、図は似ていません。
* モニターでみたとき、PDF の解像度は 96 です。つまり、`dpi = 300` のPNGファイルはPDFの約 3 倍の大きさです。

---

## 図のフォントを拡大して、PNGファイルを修正する

.panelset[
.panel[.panel-name[Code]



```r
DPI = 300
scale = DPI / 96
exceldata |&gt; 
  mutate(month = factor(month, levels = levels)) |&gt; 
  ggplot() + 
  geom_point(aes(x = month, y = temperature1)) + 
  labs(x = parse(text = xlabel), 
       y = parse(text = ylabel))  +
  theme_pubr(base_family = "notosans") +
  theme(text = element_text(size = 10 * scale))

pngfile = "temperature_plot.png"
wh = list(width = 80, height = 80)
ggsave(pngfile, width = wh$width, height = wh$height, units = "mm", dpi = DPI)
```

]

.panel[.panel-name[Result]
&lt;img src="introduction_files/figure-html/panel-1.png" width="75%" style="display: block; margin: auto;" /&gt;
]
]

---

## 研究室のワークフロー

PNGファイルのDPIをいじるのが面倒なので、PDFをPNGに変換するのが楽です。
月の頭文字をチックラベルにします。さらに、`lemon` パッケージの `geom_pointline()`を使ってみました。

.panelset[
.panel[.panel-name[ggplot2]

```r
library(lemon)
xlabel = "Month"
ylabel = "'Temperature'~(degree*C)" # plotmath expression see ?plotmath
levels = month.abb
levels = str_c(levels, ifelse(levels == "May", "", "."))
labels = str_sub(month.abb, 1, 1)
# 図の結果は plot1 にいれます。
plot1 =   exceldata |&gt; mutate(month = factor(month, levels = levels)) |&gt; 
  ggplot() + 
  geom_point(aes(x = month, y = temperature1)) +
  scale_x_discrete(name = xlabel, labels = labels) +
  scale_y_continuous(name = parse(text = ylabel), breaks = seq(21, 29, by = 1)) +
  theme_pubr(base_family = "notosans") +
  theme(text = element_text(size = 10))
```
]
.panel[.panel-name[ggsave]

まず、PDFファイルを保存します。システムフォントをPDFファイルに入れるためには `device = cairo_pdf` を渡します。




```r
wh = list(width = 80, height = 80) # 図の縦横幅
pdffile = "temperature_plot.pdf"
ggsave(pdffile, width = wh$width, height = wh$height, units = "mm", device = cairo_pdf)
```
]
.panel[.panel-name[magick]

ImageMagick のAPIを使って、PDFをPNGに変換します。
この方法だと、DPIのややこしい変換は不要です。

つぎに `magick` パッケージを読み込みます。


```r
library(magick) # imagemagick パッケージ
```

つづいて、PDF ファイルを 600 DPI で読み込む。

```r
img = image_read_pdf(pdffile, density = 600)
```

PDFファイルをPNGファイルに書き出す。


```r
img |&gt; image_write(pngfile)
```

]
]

---

## 保存の結果

&lt;img src="introduction_files/figure-html/panel2-1.png" width="80%" style="display: block; margin: auto;" /&gt;

このとき、フォントサイズは 10 pt にしました：`theme(text = element_text(size = 10))`。

---

## データを追加してプロット

.pull-left[

```r
library(viridis)
xlabel = "Month"
ylabel = "'Temperature'~(degree*C)" # plotmath expression see ?plotmath
levels = month.abb
levels = str_c(levels, ifelse(levels == "May", "", "."))
labels = str_sub(month.abb, 1, 1)
exceldata |&gt; mutate(month = factor(month, levels = levels)) |&gt; 
  ggplot() + 
  geom_pointline(aes(x = month, y = temperature1, color = "Group 1", shape = "Group 1", group = 1)) +
  geom_pointline(aes(x = month, y = temperature2, color = "Group 2", shape = "Group 2", group = 1)) +
  scale_x_discrete(name = xlabel, labels = labels) +
  scale_y_continuous(name = parse(text = ylabel), breaks = seq(15, 30, by = 5), limits = c(15, 30)) +
  scale_color_viridis("", option = "turbo", discrete = TRUE, begin = 0, end = 0.5) +
  scale_shape_discrete("") +
  theme_pubr(base_family = "notosans") +
  theme(text = element_text(size = 10),
        legend.position = c(1, 0),
        legend.justification = c(1, 0),
        legend.background = element_blank(),
        legend.title = element_blank())
```
]
.pull-right[

&lt;img src="introduction_files/figure-html/unnamed-chunk-132-1.png" width="100%" /&gt;
]

---

## 複数パネルのプロット

.panelset[
.panel[.panel-name[Code]

```r
xlabel = "Petal width (cm)"
ylabel = "Sepal width (cm)"
iris |&gt; group_nest(Species) |&gt; 
  mutate(L = c("A", "B", "C")) |&gt; 
  mutate(Species = sprintf("italic('I.')~italic('%s')~'(%s)'",  Species, L)) |&gt; 
  unnest(data) |&gt; 
  ggplot() + 
  geom_point(aes(x = Petal.Width, y = Sepal.Width, color = Species)) +
  geom_text(aes(x = 3, y = 5, label = Species), parse = TRUE, vjust = 1, hjust = 1,
            family = "notosans", size =3,  check_overlap = TRUE) +
  scale_x_continuous(name = xlabel, breaks = seq(0, 3), limits = c(0, 3)) +
  scale_y_continuous(name = ylabel, breaks = seq(0, 5), limits = c(0, 5)) +
  scale_color_viridis("", option = "turbo", discrete = TRUE, 
                      begin = 0, end = 0.5, labels = scales::parse_format()) +
  guides(color = "none") +
  facet_rep_grid(cols = vars(Species)) +
  theme_pubr(base_family = "notosans") +
  theme(text = element_text(size = 10),
        strip.background = element_blank(),
        strip.text = element_blank())
```

]

.panel[.panel-name[Output]

&lt;img src="introduction_files/figure-html/unnamed-chunk-133-1.png" width="100%" /&gt;

]
]

---

## 複数プロットの結合

.panelset[
.panel[.panel-name[Code]

```r
xlabel1 = "Petal width (cm)"
ylabel1 = "Sepal width (cm)"
xlabel2 = "Petal length (cm)"
ylabel2 = "Sepal length (cm)"

iris2 = iris |&gt; 
    mutate(Species = sprintf("italic('I.')~italic('%s')",  Species))
```
]

.panel[.panel-name[Code Plot 1]

```r
plot1 = 
  ggplot(iris2) + 
  geom_point(aes(x = Petal.Width, y = Sepal.Width, color = Species)) +
  scale_x_continuous(name = xlabel1, breaks = seq(0, 8), limits = c(0, 8)) +
  scale_y_continuous(name = ylabel1, breaks = seq(0, 8), limits = c(0, 8)) +
  scale_color_viridis("", option = "turbo", discrete = TRUE, 
                      begin = 0, end = 0.5, labels = scales::parse_format()) +
  theme_pubr(base_family = "notosans") +
  theme(text = element_text(size = 10))
```
]

.panel[.panel-name[Code Plot 2]

```r
plot2 = 
  ggplot(iris2) + 
  geom_point(aes(x = Petal.Length, y = Sepal.Length, color = Species)) +
  scale_x_continuous(name = xlabel2, breaks = seq(0, 8), limits = c(0, 8)) +
  scale_y_continuous(name = ylabel2, breaks = seq(0, 8), limits = c(0, 8)) +
  scale_color_viridis("", option = "turbo", discrete = TRUE, 
                      begin = 0, end = 0.5, labels = scales::parse_format()) +
  theme_pubr(base_family = "notosans") +
  theme(text = element_text(size = 10))
```

]
]

---

## 複数プロットの結合の結果


```r
ggarrange(plot1, plot2, 
          ncol = 2, nrow = 1,
          common.legend = TRUE, align = "hv")
```

&lt;img src="introduction_files/figure-html/unnamed-chunk-137-1.png" width="100%" /&gt;

---

## 線と点（説明変数は離散型変数の場合）

.panelset[
.panel[.panel-name[Code]

```r
ylabel = "Petal length (cm)"
iris2 |&gt; group_by(Species) |&gt; 
  summarise(PL = mean(Petal.Length),
            sd = sd(Petal.Length)) |&gt; 
  mutate(lower = PL - sd,
         upper = PL + sd) |&gt; 
ggplot() + 
  geom_line(aes(x = Species, y = PL, group = 1)) +
  geom_point(aes(x = Species, y = PL), size = 2, color = "white") +
  geom_point(aes(x = Species, y = PL), size = 1) +
  geom_errorbar(aes(x = Species, ymin = lower, ymax = upper),
                width = 0.0) +  
  scale_x_discrete(name = "Species", labels = scales::parse_format()) +
  scale_y_continuous(name = ylabel, breaks = seq(0, 8), limits = c(0, 8)) +
  theme_pubr(base_family = "notosans") +
  theme(text = element_text(size = 10))
```

]

.panel[.panel-name[Output]

&lt;img src="introduction_files/figure-html/unnamed-chunk-138-1.png" width="100%" /&gt;

]
]

---

## ボーグラフ

.panelset[
.panel[.panel-name[Code]

```r
ylabel = "Petal length (cm)"
iris2 |&gt; group_by(Species) |&gt; 
  summarise(PL = mean(Petal.Length),
            sd = sd(Petal.Length)) |&gt; 
  mutate(lower = PL - sd,
         upper = PL + sd) |&gt; 
ggplot() + 
  geom_col(aes(x = Species, y = PL, fill = Species)) +
  geom_errorbar(aes(x = Species, ymin = lower, ymax = upper),
                width = 0.01) +  
  scale_x_discrete(name = "Species", labels = scales::parse_format()) +
  scale_y_continuous(name = ylabel, breaks = seq(0, 8), limits = c(0, 8)) +
  scale_fill_viridis("", option = "turbo", discrete = TRUE, 
                      begin = 0, end = 0.5, labels = scales::parse_format()) +
  guides(fill = "none") +
  theme_pubr(base_family = "notosans") +
  theme(text = element_text(size = 10))
```

]

.panel[.panel-name[Output]

&lt;img src="introduction_files/figure-html/unnamed-chunk-139-1.png" width="100%" /&gt;

]
]

---

## ボーグラフ（横向き・並び替える）

.panelset[
.panel[.panel-name[Code]

```r
ylabel = "Petal length (cm)"
iris2 |&gt; group_by(Species) |&gt; 
  summarise(PL = mean(Petal.Length),
            sd = sd(Petal.Length)) |&gt; 
  mutate(lower = PL - sd,
         upper = PL + sd) |&gt; 
  ggplot(aes(x = fct_reorder(Species, PL, .desc = T))) + 
  geom_col(aes(y = PL, fill = Species)) +
  geom_errorbar(aes(ymin = lower, ymax = upper),
                width = 0.1) +  
  scale_x_discrete(name = "Species", labels = scales::parse_format()) +
  scale_y_continuous(name = ylabel, breaks = seq(0, 8), limits = c(0, 8)) +
  scale_fill_viridis("", option = "turbo", discrete = TRUE, 
                      begin = 0, end = 0.5, labels = scales::parse_format()) +
  guides(fill = "none") +
  theme_pubr(base_family = "notosans") +
  theme(text = element_text(size = 10))+ 
  coord_flip()
```

]

.panel[.panel-name[Output]

&lt;img src="introduction_files/figure-html/unnamed-chunk-140-1.png" width="100%" /&gt;

]
]


---

## ヒストグラム

.panelset[
.panel[.panel-name[Code]

```r
xlabel = "Petal length (cm)"
ylabel = "Frequency"
iris2 |&gt; 
  ggplot() + 
  geom_histogram(aes(x = Petal.Length, fill = Species)) +
  scale_x_continuous(name = xlabel) +
  scale_y_continuous(name = ylabel) +
  scale_fill_viridis("", option = "turbo", discrete = TRUE, 
                      begin = 0, end = 0.5, labels = scales::parse_format()) +
  theme_pubr(base_family = "notosans") +
  theme(text = element_text(size = 10),
        legend.position = c(1,1),
        legend.justification = c(1,1))
```

]

.panel[.panel-name[Output]

&lt;img src="introduction_files/figure-html/unnamed-chunk-141-1.png" width="100%" /&gt;

]
]


---

## ヒストグラム・パネル

.panelset[
.panel[.panel-name[Code]

```r
xlabel = "Petal length (cm)"
ylabel = "Frequency"
iris2 |&gt; 
  ggplot() + 
  geom_histogram(aes(x = Petal.Length, fill = Species),
                 binwidth = 0.1, center = 0) +
  scale_x_continuous(name = xlabel, limits = c(0, 10)) +
  scale_y_continuous(name = ylabel) +
  scale_fill_viridis("", option = "turbo", discrete = TRUE, 
                      begin = 0, end = 0.5, labels = scales::parse_format()) +
  facet_rep_wrap(facets = vars(Species)) +
  theme_pubr(base_family = "notosans") +
  theme(text = element_text(size = 10),
        legend.position = c(1,1),
        legend.justification = c(1,1),
        strip.background = element_blank(),
        strip.text = element_blank())
```

]

.panel[.panel-name[Output]

&lt;img src="introduction_files/figure-html/unnamed-chunk-142-1.png" width="100%" /&gt;

]
]

---

## 時系列

データは (https://covid.ourworldindata.org/data/owid-covid-data.csv)。

.panelset[
.panel[.panel-name[Code 1]

```r
covid = read_csv("https://covid.ourworldindata.org/data/owid-covid-data.csv")
covid2 = covid |&gt; 
  group_by(continent, date) |&gt; 
  summarise(tc = sum(total_cases_per_million, na.rm=T),
            td = sum(total_deaths_per_million, na.rm= T)) |&gt; 
  drop_na()
```
]

.panel[.panel-name[Code 2]

```r
xlabel = "Date"
ylabel = "COVID cases per million"
ggplot(covid2) +
  geom_path(aes(x=date, y = tc, color = continent))+
  scale_x_date(name = xlabel) +
  scale_y_continuous(name = ylabel) +
  scale_color_viridis("", option = "turbo", discrete = TRUE, begin = 0, end = 0.8) +
  theme_pubr(base_family = "notosans") +
  theme(text = element_text(size = 10),
        legend.position = c(0,1),
        legend.justification = c(0,1),
        strip.background = element_blank(),
        strip.text = element_blank())
```
]

.panel[.panel-name[Output]
&lt;img src="introduction_files/figure-html/unnamed-chunk-145-1.png" width="100%" /&gt;
]
]

---

## 時系列

.panelset[
.panel[.panel-name[Code]

```r
xlabel = "Date"
ylabel = "COVID cases per million"
ggplot(covid2) +
  geom_path(aes(x=date, y = tc, color = continent))+
  scale_x_date(name = xlabel, date_labels = "%Y-%m-%d") +
  scale_y_continuous(name = ylabel, 
                     breaks = 10^seq(-2,7), limits = c(0.01, 10^7),
                     trans = "log10", labels = scales::label_math(format = log10)) +
  scale_color_viridis("", option = "turbo", discrete = TRUE, begin = 0, end = 0.8) +
  guides(color = guide_legend(ncol = 2)) +
  theme_pubr(base_family = "notosans") +
  theme(text = element_text(size = 10),
        legend.position = c(0.5,0),
        legend.justification = c(0,0),
        legend.background = element_blank(),
        strip.background = element_blank(),
        strip.text = element_blank())
```

]

.panel[.panel-name[Output]

&lt;img src="introduction_files/figure-html/unnamed-chunk-146-1.png" width="100%" /&gt;

]
]

---

## 時系列軸のカスタムラベル


```r
gnn_date = function() {
  function(x) {
    m = format(x, "%b")
    m = str_sub(m, start = 1, end = 1)
    y = format(x, "%Y")
    ifelse(duplicated(y), m, sprintf("%s\n%s", m,y))
  }
}
```

---

## 時系列

.panelset[
.panel[.panel-name[Code]

```r
xlabel = "Date"
ylabel = "COVID cases per million"
ggplot(covid2) +
  geom_path(aes(x=date, y = tc, color = continent))+
  scale_x_date(name = xlabel, date_breaks = "months", labels = gnn_date()) +
  scale_y_continuous(name = ylabel, 
                     breaks = 10^seq(-2,7, by = 2), limits = c(0.01, 10^7),
                     trans = "log10", labels = scales::label_math(format = log10)) +
  scale_color_viridis("", option = "turbo", discrete = TRUE, begin = 0, end = 0.8) +
  guides(color = guide_legend(ncol = 2)) +
  theme_pubr(base_family = "notosans") +
  theme(text = element_text(size = 10),
        legend.position = c(0.5,0),
        legend.justification = c(0,0),
        legend.background = element_blank(),
        strip.background = element_blank(),
        strip.text = element_blank())
```

]

.panel[.panel-name[Output]

&lt;img src="introduction_files/figure-html/unnamed-chunk-148-1.png" width="100%" /&gt;

]
]

---

## 箱ひげ図

.panelset[

.panel[.panel-name[Code 1]

```r
covid2 = covid |&gt; 
  filter(date &gt;= lubridate::ymd("2021-01-01")) |&gt; 
  filter(str_detect(location, "Indonesia|Japan|South Korea|Taiwan|China"))
```
]

.panel[.panel-name[Code 2]

```r
xlabel = "Country"
ylabel = "Daily cases per million"
ggplot(covid2) +
  geom_boxplot(aes(x = fct_reorder(location, new_cases_per_million, mean, na.rm=T, .desc=T), 
                   y = new_cases_per_million, fill = location)) + 
  scale_x_discrete(name = xlabel) +
  scale_y_continuous(name = ylabel, 
                     breaks = 10^seq(-3,3, by = 1), limits = 10^c(-3, 3),
                     trans = "log10", labels = scales::label_math(format = log10)) +
  scale_color_viridis("", option = "turbo", discrete = TRUE, begin = 0, end = 0.8) +
  guides(fill = guide_legend(ncol = 2)) +
  theme_pubr(base_family = "notosans") +
  theme(text = element_text(size = 10),
        legend.position = c(0,0),
        legend.justification = c(0,0),
        legend.background = element_blank(),
        legend.title = element_blank(),
        strip.background = element_blank(),
        strip.text = element_blank())
```
]
.panel[.panel-name[Output]
&lt;img src="introduction_files/figure-html/unnamed-chunk-150-1.png" width="100%" /&gt;
]
]
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"slideNumberFormat": "%current% / %total%",
"highlightStyle": "monokai",
"highlightLines": true,
"ratio": "16:9",
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
